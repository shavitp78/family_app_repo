<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>משפחת פופקו</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { direction: rtl; }
        .week-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .day-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            border-right: 4px solid #4f46e5;
        }
        .transport-option-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background-color: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .transport-option-btn:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .transport-option-btn.active {
            border-color: #3b82f6;
            background-color: #3b82f6;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .recurring-option-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background-color: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        .recurring-option-btn:hover {
            border-color: #059669;
            background-color: #ecfdf5;
        }
        .recurring-option-btn.active {
            border-color: #059669;
            background-color: #059669;
            color: white;
        }
        @media (max-width: 768px) {
            .week-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loading" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-lg font-bold text-gray-700">טוען...</p>
        </div>
    </div>

    <!-- Modal for editing events -->
    <div id="edit-event-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">עריכת אירוע</h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <input type="text" placeholder="פעילות" class="w-full p-3 border rounded-lg" id="edit-event-activity">
                <select class="w-full p-3 border rounded-lg" id="edit-event-member">
                    <option value="">בחר בן משפחה</option>
                </select>
                <input type="date" class="w-full p-3 border rounded-lg" id="edit-event-date">
                <input type="time" class="w-full p-3 border rounded-lg" id="edit-event-time">
                
                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">סוג הסעה (אופציונלי)</h4>
                    <div id="edit-transport-options" class="flex items-center gap-3">
                        <button type="button" class="transport-option-btn" data-value="הלוך" onclick="toggleTransport(this, 'edit')">הלוך</button>
                        <button type="button" class="transport-option-btn" data-value="חזור" onclick="toggleTransport(this, 'edit')">חזור</button>
                        <button type="button" class="transport-option-btn" data-value="לרכבת" onclick="toggleTransport(this, 'edit')">לרכבת</button>
                    </div>
                </div>

                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">אירוע חוזר</h4>
                    <div id="edit-recurring-options" class="flex items-center gap-2 flex-wrap">
                        <button type="button" class="recurring-option-btn" data-value="none" onclick="toggleRecurring(this, 'edit')">ללא חזרה</button>
                        <button type="button" class="recurring-option-btn" data-value="daily" onclick="toggleRecurring(this, 'edit')">יומי</button>
                        <button type="button" class="recurring-option-btn" data-value="weekly" onclick="toggleRecurring(this, 'edit')">שבועי</button>
                        <button type="button" class="recurring-option-btn" data-value="monthly" onclick="toggleRecurring(this, 'edit')">חודשי</button>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="saveEditedEvent()" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        שמור שינויים
                    </button>
                    <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        ביטול
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="app" style="display: none;">
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <h1 class="text-xl font-bold text-gray-800">ניהול משפחתי - משפחת פופקו</h1>
                    <div class="flex space-x-2" id="nav-buttons"></div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 py-8" id="main-content"></main>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDOQ29YJkEQqSk9j7FvNsZEwE-xuVh5kQU",
            authDomain: "family-popko.firebaseapp.com",
            databaseURL: "https://family-popko-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "family-popko",
            storageBucket: "family-popko.appspot.com",
            messagingSenderId: "902790940853",
            appId: "1:902790940853:web:23238a2f63612d3ac3d6fc"
        };

        let database;
        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('Firebase initialized successfully');
            } else {
                throw new Error("Firebase library not loaded");
            }
        } catch (error) {
            console.error('Error initializing Firebase:', error);
            const loadingDiv = document.getElementById('loading');
            if (loadingDiv) {
                loadingDiv.innerHTML = `
                    <div class="text-center">
                        <div class="text-red-500 text-xl mb-4">⚠️ Error connecting to the database</div>
                        <p class="text-gray-600">Could not connect to the Firebase database.</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded">Try Again</button>
                    </div>
                `;
            }
        }

        // Global Variables
        let currentView = 'home';
        let currentArrangement = 0;
        let calendar = [];
        let shoppingList = [];
        let customTasks = [];
        let isInitialLoad = true;
        let editingEventId = null;

        const familyMembers = ['טליה', 'שביט', 'שגיא', 'אביתר', 'לביא'];
        const daysOfWeekHebrew = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
        
        const taskArrangements = [
            { 'שגיא': 'פח', 'אביתר': 'מדיח', 'לביא': 'מחזור' },
            { 'שגיא': 'מדיח', 'אביתר': 'מחזור', 'לביא': 'פח' },
            { 'שגיא': 'מחזור', 'אביתר': 'פח', 'לביא': 'מדיח' }
        ];

        // Helper Functions
        function formatDate(date) {
            return new Date(date).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });
        }

        function getWeekStartDate(weekOffset = 0) {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysToSunday = dayOfWeek === 0 ? 0 : -dayOfWeek;
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() + daysToSunday + (weekOffset * 7));
            weekStart.setHours(0, 0, 0, 0);
            return weekStart;
        }

        // Transport and Recurring functions
        function toggleTransport(selectedBtn, context = 'new') {
            const containerId = context === 'edit' ? 'edit-transport-options' : 'transport-options';
            const optionsContainer = document.getElementById(containerId);
            const isAlreadyActive = selectedBtn.classList.contains('active');

            optionsContainer.querySelectorAll('.transport-option-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            if (!isAlreadyActive) {
                selectedBtn.classList.add('active');
            }
        }

        function toggleRecurring(selectedBtn, context = 'new') {
            const containerId = context === 'edit' ? 'edit-recurring-options' : 'recurring-options';
            const optionsContainer = document.getElementById(containerId);

            optionsContainer.querySelectorAll('.recurring-option-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            selectedBtn.classList.add('active');
        }

        // Recurring event generation
        function generateRecurringEvents(baseEvent, recurringType, endDate = null) {
            const events = [];
            const baseDate = new Date(baseEvent.date);
            const maxEvents = 52; // Maximum 52 occurrences
            let currentDate = new Date(baseDate);
            let count = 0;

            if (!endDate) {
                endDate = new Date();
                endDate.setFullYear(endDate.getFullYear() + 1); // Default to 1 year
            }

            while (currentDate <= endDate && count < maxEvents) {
                if (count > 0) { // Skip the first one as it's the original event
                    const newEvent = {
                        ...baseEvent,
                        id: Date.now() + count,
                        date: currentDate.toISOString().split('T')[0],
                        isRecurring: true,
                        originalEventId: baseEvent.id
                    };
                    events.push(newEvent);
                }

                // Calculate next occurrence
                switch (recurringType) {
                    case 'daily':
                        currentDate.setDate(currentDate.getDate() + 1);
                        break;
                    case 'weekly':
                        currentDate.setDate(currentDate.getDate() + 7);
                        break;
                    case 'monthly':
                        currentDate.setMonth(currentDate.getMonth() + 1);
                        break;
                }
                count++;
            }

            return events;
        }

        // Data processing function
        function processData(snapshot) {
            const data = snapshot.val();
            if (!data) {
                console.log("No data found in Firebase. Initializing empty state.");
                calendar = [];
                shoppingList = [];
                customTasks = [];
            } else {
                calendar = data.calendar || [];
                shoppingList = data.shopping || [];
                customTasks = data.customTasks || [];
                currentArrangement = data.arrangement || 0;
            }

            if (isInitialLoad) {
                renderApp();
                isInitialLoad = false;
            } else {
                renderCurrentView();
            }
        }
        
        // Firebase Functions
        async function saveData(path, data) {
            try {
                if(!database) return;
                await database.ref(`family/${path}`).set(data);
                console.log(`Data saved successfully: ${path}`);
            } catch (error) {
                console.error(`Error saving data: ${path}`, error);
            }
        }

        // Calendar Functions
        async function addCalendarEvent(activity, member, date, time, transport = null, recurring = 'none') {
            const newEvent = {
                id: Date.now(),
                activity: activity,
                member: member,
                date: date,
                time: time,
                transport: transport,
                recurring: recurring,
                isRecurring: false
            };

            calendar.push(newEvent);

            // Generate recurring events if needed
            if (recurring && recurring !== 'none') {
                const recurringEvents = generateRecurringEvents(newEvent, recurring);
                calendar.push(...recurringEvents);
            }

            await saveData('calendar', calendar);
        }

        async function updateCalendarEvent(eventId, activity, member, date, time, transport = null, recurring = 'none') {
            const eventIndex = calendar.findIndex(event => event.id === eventId);
            if (eventIndex === -1) return;

            const oldEvent = calendar[eventIndex];
            
            // Remove old recurring events if they exist
            if (oldEvent.recurring && oldEvent.recurring !== 'none') {
                calendar = calendar.filter(event => event.originalEventId !== eventId);
            }

            // Update the main event
            calendar[eventIndex] = {
                ...oldEvent,
                activity: activity,
                member: member,
                date: date,
                time: time,
                transport: transport,
                recurring: recurring
            };

            // Generate new recurring events if needed
            if (recurring && recurring !== 'none') {
                const recurringEvents = generateRecurringEvents(calendar[eventIndex], recurring);
                calendar.push(...recurringEvents);
            }

            await saveData('calendar', calendar);
        }

        async function removeCalendarEvent(id) {
            // Remove the main event and any recurring events
            calendar = calendar.filter(event => event.id !== id && event.originalEventId !== id);
            await saveData('calendar', calendar);
        }

        // Edit Event Functions
        function openEditModal(eventId) {
            const event = calendar.find(e => e.id === eventId);
            if (!event) return;

            editingEventId = eventId;
            
            // Populate the edit form
            document.getElementById('edit-event-activity').value = event.activity;
            document.getElementById('edit-event-member').value = event.member;
            document.getElementById('edit-event-date').value = event.date;
            document.getElementById('edit-event-time').value = event.time;

            // Populate family members dropdown
            const memberSelect = document.getElementById('edit-event-member');
            memberSelect.innerHTML = '<option value="">בחר בן משפחה</option>' +
                familyMembers.map(member => `<option value="${member}" ${member === event.member ? 'selected' : ''}>${member}</option>`).join('');

            // Set transport option
            if (event.transport) {
                const transportBtn = document.querySelector(`#edit-transport-options [data-value="${event.transport}"]`);
                if (transportBtn) transportBtn.classList.add('active');
            }

            // Set recurring option
            const recurringValue = event.recurring || 'none';
            const recurringBtn = document.querySelector(`#edit-recurring-options [data-value="${recurringValue}"]`);
            if (recurringBtn) recurringBtn.classList.add('active');

            document.getElementById('edit-event-modal').classList.add('show');
        }

        function closeEditModal() {
            editingEventId = null;
            document.getElementById('edit-event-modal').classList.remove('show');
            
            // Clear form
            document.getElementById('edit-event-activity').value = '';
            document.getElementById('edit-event-member').value = '';
            document.getElementById('edit-event-date').value = '';
            document.getElementById('edit-event-time').value = '';

            // Clear active buttons
            document.querySelectorAll('#edit-transport-options .active, #edit-recurring-options .active').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        async function saveEditedEvent() {
            if (!editingEventId) return;

            const activity = document.getElementById('edit-event-activity').value;
            const member = document.getElementById('edit-event-member').value;
            const date = document.getElementById('edit-event-date').value;
            const time = document.getElementById('edit-event-time').value;

            const activeTransportBtn = document.querySelector('#edit-transport-options .active');
            const transportValue = activeTransportBtn ? activeTransportBtn.dataset.value : null;

            const activeRecurringBtn = document.querySelector('#edit-recurring-options .active');
            const recurringValue = activeRecurringBtn ? activeRecurringBtn.dataset.value : 'none';

            if (activity && member && date && time) {
                await updateCalendarEvent(editingEventId, activity, member, date, time, transportValue, recurringValue);
                closeEditModal();
            }
        }

        // Other data functions (Shopping, Custom Tasks, etc.)
        async function addShoppingItem(item, addedBy) {
            const newItem = {
                id: Date.now(),
                item: item,
                addedBy: addedBy || 'לא ידוע',
                completed: false,
                dateAdded: new Date().toISOString()
            };
            shoppingList.push(newItem);
            await saveData('shopping', shoppingList);
        }

        async function toggleShoppingItem(id) {
            const item = shoppingList.find(item => item.id === id);
            if (item) {
                item.completed = !item.completed;
                await saveData('shopping', shoppingList);
            }
        }

        async function removeShoppingItem(id) {
            shoppingList = shoppingList.filter(item => item.id !== id);
            await saveData('shopping', shoppingList);
        }

        async function addCustomTask(title, assignedTo, targetDate) {
            const newTask = {
                id: Date.now(),
                title: title,
                assignedTo: assignedTo,
                completed: false,
                dateCreated: new Date().toISOString(),
                targetDate: targetDate || null
            };
            customTasks.push(newTask);
            await saveData('customTasks', customTasks);
        }

        async function toggleCustomTask(id) {
            const task = customTasks.find(task => task.id === id);
            if (task) {
                task.completed = !task.completed;
                await saveData('customTasks', customTasks);
            }
        }

        async function removeCustomTask(id) {
            customTasks = customTasks.filter(task => task.id !== id);
            await saveData('customTasks', customTasks);
        }

        async function changeArrangement() {
            currentArrangement = (currentArrangement + 1) % 3;
            await saveData('arrangement', currentArrangement);
        }

        // UI Functions
        function setCurrentView(view) {
            currentView = view;
            renderCurrentView();
            renderNavigation();
        }

        function renderNavigation() {
            const navButtons = document.getElementById('nav-buttons');
            navButtons.innerHTML = `
                <button onclick="setCurrentView('home')" class="px-4 py-2 rounded-lg flex items-center space-x-1 ${currentView === 'home' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="home" class="w-4 h-4"></i>
                    <span>בית</span>
                </button>
                <button onclick="setCurrentView('calendar')" class="px-4 py-2 rounded-lg flex items-center space-x-1 ${currentView === 'calendar' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span>לוז</span>
                </button>
                <button onclick="setCurrentView('shopping')" class="px-4 py-2 rounded-lg flex items-center space-x-1 ${currentView === 'shopping' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                    <span>קניות</span>
                </button>
                <button onclick="setCurrentView('custom-tasks')" class="px-4 py-2 rounded-lg flex items-center space-x-1 ${currentView === 'custom-tasks' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>משימות</span>
                </button>
            `;
            lucide.createIcons();
        }

        function renderHomeView() {
            const pendingShoppingItems = shoppingList.filter(item => !item.completed).length;
            
            const getWeekEventsHTML = (weekOffset) => {
                const weekStart = getWeekStartDate(weekOffset);
                const weekEnd = new Date(weekStart.getTime() + 6 * 24 * 60 * 60 * 1000);
                weekEnd.setHours(23, 59, 59, 999);

                const weekEvents = calendar.filter(event => {
                    const eventDate = new Date(event.date);
                    return eventDate >= weekStart && eventDate <= weekEnd;
                });

                if (weekEvents.length === 0) {
                    return `<div class="text-center text-gray-500 py-4">אין אירועים מתוכננים</div>`;
                }

                const eventsByDate = weekEvents.reduce((acc, event) => {
                    const dateKey = event.date;
                    if (!acc[dateKey]) {
                        acc[dateKey] = [];
                    }
                    acc[dateKey].push(event);
                    return acc;
                }, {});

                const sortedDates = Object.keys(eventsByDate).sort();

                return sortedDates.map(date => {
                    const dayEvents = eventsByDate[date].sort((a,b) => a.time.localeCompare(b.time));
                    const dayDate = new Date(date);
                    const dayName = daysOfWeekHebrew[dayDate.getDay()];
                    
                    return `
                        <div class="day-card mb-4">
                            <h4 class="font-bold text-lg text-indigo-700 mb-2">${dayName}, ${formatDate(dayDate)}</h4>
                            <div class="space-y-3">
                            ${dayEvents.map(event => `
                                <div class="p-3 bg-indigo-50 rounded-lg">
                                    <div class="font-medium text-gray-800">${event.activity}</div>
                                    <div class="text-sm text-gray-600">
                                        <i data-lucide="user" class="inline-block w-3 h-3"></i> ${event.member}
                                        <i data-lucide="clock" class="inline-block w-3 h-3 mr-2"></i> ${event.time}
                                        ${event.transport ? `<span class="text-orange-600 font-bold ml-2"><i data-lucide="car" class="inline-block w-3 h-3 ml-1"></i>הסעה: ${event.transport}</span>` : ''}
                                        ${event.recurring && event.recurring !== 'none' ? `<span class="text-green-600 font-bold ml-2"><i data-lucide="repeat" class="inline-block w-3 h-3 ml-1"></i>חוזר</span>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            };

            return `
                <div class="space-y-6">
                    <div class="bg-blue-50 p-4 rounded-lg flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-bold text-blue-800">סידור משימות #${currentArrangement + 1}</h2>
                            <p class="text-sm text-blue-700 mt-1">ניהול משימות שבועיות (פח, מדיח, מחזור) מתבצע בטאב "משימות".</p>
                        </div>
                        <button onclick="changeArrangement()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            סידור הבא
                        </button>
                    </div>

                    ${pendingShoppingItems > 0 ? `
                        <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg cursor-pointer" onclick="setCurrentView('shopping')">
                            <div class="flex items-center">
                                <i data-lucide="shopping-cart" class="w-5 h-5 text-orange-600 ml-2"></i>
                                <span class="font-medium text-orange-800">
                                    יש ${pendingShoppingItems} פריטים ברשימת הקניות
                                </span>
                            </div>
                        </div>
                    ` : ''}

                    <div class="week-header">
                        <h3 class="text-xl font-bold">לוז לשבוע הנוכחי</h3>
                    </div>
                    <div>
                        ${getWeekEventsHTML(0)}
                    </div>

                    <div class="week-header">
                        <h3 class="text-xl font-bold">לוז לשבוע הבא</h3>
                    </div>
                    <div>
                        ${getWeekEventsHTML(1)}
                    </div>
                </div>
            `;
        }

        function renderCalendarView() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">לוח משפחתי</h2>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">הוספת אירוע</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" placeholder="פעילות" class="p-3 border rounded-lg" id="new-event-activity">
                            <select class="p-3 border rounded-lg" id="new-event-member">
                                <option value="">בחר בן משפחה</option>
                                ${familyMembers.map(member => `<option value="${member}">${member}</option>`).join('')}
                            </select>
                            <input type="date" class="p-3 border rounded-lg" id="new-event-date">
                            <input type="time" class="p-3 border rounded-lg" id="new-event-time">
                        </div>

                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">סוג הסעה (אופציונלי)</h4>
                            <div id="transport-options" class="flex items-center gap-3">
                                <button type="button" class="transport-option-btn" data-value="הלוך" onclick="toggleTransport(this)">הלוך</button>
                                <button type="button" class="transport-option-btn" data-value="חזור" onclick="toggleTransport(this)">חזור</button>
                                <button type="button" class="transport-option-btn" data-value="לרכבת" onclick="toggleTransport(this)">לרכבת</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">אירוע חוזר</h4>
                            <div id="recurring-options" class="flex items-center gap-2 flex-wrap">
                                <button type="button" class="recurring-option-btn active" data-value="none" onclick="toggleRecurring(this)">ללא חזרה</button>
                                <button type="button" class="recurring-option-btn" data-value="daily" onclick="toggleRecurring(this)">יומי</button>
                                <button type="button" class="recurring-option-btn" data-value="weekly" onclick="toggleRecurring(this)">שבועי</button>
                                <button type="button" class="recurring-option-btn" data-value="monthly" onclick="toggleRecurring(this)">חודשי</button>
                            </div>
                        </div>
                        
                        <button onclick="addNewCalendarEvent()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            הוסף אירוע
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">כל האירועים</h3>
                        <div class="space-y-3">
                            ${calendar.length > 0 ? calendar
                                .sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`))
                                .map(event => `
                                <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="font-medium">${event.activity}</div>
                                            <div class="text-sm text-gray-600">
                                                ${event.member} • ${new Date(event.date).toLocaleDateString('he-IL')} • ${event.time}
                                                ${event.transport ? `<span class="text-orange-600 font-bold"> • הסעה: ${event.transport}</span>` : ''}
                                                ${event.recurring && event.recurring !== 'none' ? `<span class="text-green-600 font-bold"> • חוזר ${event.recurring === 'daily' ? 'יומי' : event.recurring === 'weekly' ? 'שבועי' : 'חודשי'}</span>` : ''}
                                                ${event.isRecurring ? '<span class="text-purple-600 font-bold"> • (חוזר)</span>' : ''}
                                            </div>
                                        </div>
                                        <div class="flex gap-2 mr-4">
                                            ${!event.isRecurring ? `<button onclick="openEditModal(${event.id})" class="text-blue-500 hover:text-blue-700" title="עריכת אירוע">
                                                <i data-lucide="edit" class="w-4 h-4"></i>
                                            </button>` : ''}
                                            <button onclick="removeCalendarEvent(${event.id})" class="text-red-500 hover:text-red-700" title="מחיקת אירוע">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<div class="text-center text-gray-500 py-8">אין אירועים מתוכננים</div>'}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderShoppingView() {
           return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">רשימת קניות</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" placeholder="מה לקנות?" class="p-3 border rounded-lg" id="new-item" onkeypress="if(event.key === 'Enter') addNewShoppingItem()">
                            <select class="p-3 border rounded-lg" id="new-item-by">
                                <option value="">מי מבקש?</option>
                                ${familyMembers.map(member => `<option value="${member}">${member}</option>`).join('')}
                            </select>
                        </div>
                        <button onclick="addNewShoppingItem()" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600">
                            הוסף לרשימה
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-lg font-bold text-red-600 mb-4">
                                לקנות (${shoppingList.filter(item => !item.completed).length})
                            </h3>
                            <div class="space-y-2">
                                ${shoppingList.filter(item => !item.completed).map(item => `
                                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                        <div class="flex items-center space-x-2">
                                            <button onclick="toggleShoppingItem(${item.id})">
                                                <i data-lucide="circle" class="w-5 h-5 text-red-500"></i>
                                            </button>
                                            <div>
                                                <div class="font-medium">${item.item}</div>
                                                <div class="text-sm text-gray-600">הוסיף/ה: ${item.addedBy}</div>
                                            </div>
                                        </div>
                                        <button onclick="removeShoppingItem(${item.id})">
                                            <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-lg font-bold text-green-600 mb-4">
                                נקנו (${shoppingList.filter(item => item.completed).length})
                            </h3>
                            <div class="space-y-2">
                                ${shoppingList.filter(item => item.completed).map(item => `
                                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                        <div class="flex items-center space-x-2">
                                             <button onclick="toggleShoppingItem(${item.id})">
                                                <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                                             </button>
                                            <div>
                                                <div class="font-medium line-through text-gray-500">${item.item}</div>
                                                <div class="text-sm text-gray-500">הוסיף/ה: ${item.addedBy}</div>
                                            </div>
                                        </div>
                                        <button onclick="removeShoppingItem(${item.id})">
                                            <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCustomTasksView() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">ניהול משימות</h2>
                    
                     <div class="bg-white p-6 rounded-lg shadow-lg">
                         <h3 class="text-lg font-bold text-gray-800 mb-4">משימות שבועיות קבועות</h3>
                         <p class="text-sm text-gray-600">המשימות היומיות (פח, מדיח וכו') מתאפסות אוטומטית בכל מוצאי שבת. ניתן לשנות את הסידור מהכפתור בעמוד הבית.</p>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                         <h3 class="text-lg font-bold text-gray-800 mb-4">הוספת משימה חד פעמית</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input type="text" placeholder="כותרת המשימה" class="p-3 border rounded-lg" id="new-task-title">
                            <select class="p-3 border rounded-lg" id="new-task-assignee">
                                <option value="">למי להקצות?</option>
                                ${familyMembers.map(member => `<option value="${member}">${member}</option>`).join('')}
                            </select>
                            <input type="date" class="p-3 border rounded-lg" id="new-task-target-full" title="תאריך יעד">
                        </div>
                        <button onclick="addNewCustomTask()" class="px-6 py-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">
                            הוסף משימה
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            משימות פעילות (${customTasks.filter(task => !task.completed).length})
                        </h3>
                        <div class="space-y-3">
                            ${customTasks.filter(task => !task.completed).map(task => `
                                <div class="p-4 rounded-lg border bg-gray-50 border-gray-200">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <button onclick="toggleCustomTask(${task.id})">
                                                <i data-lucide="circle" class="w-6 h-6 text-gray-400 hover:text-green-500"></i>
                                            </button>
                                            <div>
                                                <div class="font-medium text-lg">${task.title}</div>
                                                <div class="text-sm text-gray-600">
                                                    אחראי: ${task.assignedTo}
                                                    ${task.targetDate ? `• יעד: ${new Date(task.targetDate).toLocaleDateString('he-IL')}` : ''}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="removeCustomTask(${task.id})">
                                                <i data-lucide="trash-2" class="w-5 h-5 text-red-500"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-green-600 mb-4">
                            משימות שבוצעו (${customTasks.filter(task => task.completed).length})
                        </h3>
                        <div class="space-y-2">
                            ${customTasks.filter(task => task.completed).map(task => `
                                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                    <div class="flex items-center space-x-2">
                                         <button onclick="toggleCustomTask(${task.id})">
                                            <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                                         </button>
                                        <div>
                                            <div class="font-medium line-through text-gray-500">${task.title}</div>
                                            <div class="text-sm text-gray-500">${task.assignedTo}</div>
                                        </div>
                                    </div>
                                    <button onclick="removeCustomTask(${task.id})">
                                        <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderCurrentView() {
            let content = '';
            switch (currentView) {
                case 'home': content = renderHomeView(); break;
                case 'calendar': content = renderCalendarView(); break;
                case 'shopping': content = renderShoppingView(); break;
                case 'custom-tasks': content = renderCustomTasksView(); break;
                default: content = renderHomeView();
            }
            document.getElementById('main-content').innerHTML = content;
            lucide.createIcons();
        }

        function renderApp() {
            renderNavigation();
            renderCurrentView();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        }
        
        // Helper UI Functions
        function addNewShoppingItem() {
            const itemInput = document.getElementById('new-item');
            const bySelect = document.getElementById('new-item-by');
            if (itemInput.value.trim() && bySelect.value) {
                addShoppingItem(itemInput.value.trim(), bySelect.value);
                itemInput.value = '';
                bySelect.value = '';
            }
        }
        
        function addNewCalendarEvent() {
            const activity = document.getElementById('new-event-activity');
            const member = document.getElementById('new-event-member');
            const date = document.getElementById('new-event-date');
            const time = document.getElementById('new-event-time');
            
            const activeTransportBtn = document.querySelector('#transport-options .active');
            const transportValue = activeTransportBtn ? activeTransportBtn.dataset.value : null;

            const activeRecurringBtn = document.querySelector('#recurring-options .active');
            const recurringValue = activeRecurringBtn ? activeRecurringBtn.dataset.value : 'none';

            if (activity.value && member.value && date.value && time.value) {
                addCalendarEvent(activity.value, member.value, date.value, time.value, transportValue, recurringValue);
                
                // Reset form
                activity.value = '';
                member.value = '';
                date.value = '';
                time.value = '';
                
                // Reset transport buttons
                document.querySelectorAll('#transport-options .active').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Reset recurring to "none"
                document.querySelectorAll('#recurring-options .active').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector('#recurring-options [data-value="none"]').classList.add('active');
            }
        }

        function addNewCustomTask() {
            const title = document.getElementById('new-task-title');
            const assignee = document.getElementById('new-task-assignee');
            const target = document.getElementById('new-task-target-full');
            
            if (title.value && assignee.value) {
                addCustomTask(title.value, assignee.value, target.value);
                title.value = '';
                assignee.value = '';
                target.value = '';
            }
        }
        
        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing application...');
            
            if (!database) {
                 console.error('Database not initialized. Halting execution.');
                 return;
            }

            // Listen for real-time updates from Firebase
            try {
                database.ref('family').on('value', (snapshot) => {
                    console.log('Real-time update from database received.');
                    processData(snapshot);
                }, (error) => {
                    console.error('Error listening for real-time updates:', error);
                });
            } catch (error) {
                console.error('Error setting up real-time listener:', error);
            }
        });
    </script>
</body>
</html>