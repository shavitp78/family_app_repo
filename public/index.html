<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>משפחת פופקו</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { direction: rtl; }
        .week-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .day-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            border-right: 4px solid #4f46e5;
        }
        .transport-option-btn, .time-option-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background-color: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .transport-option-btn:hover, .time-option-btn:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .transport-option-btn.active, .time-option-btn.active {
            border-color: #3b82f6;
            background-color: #3b82f6;
            color: white;
        }
        .driver-option-btn {
            padding: 6px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background-color: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        .driver-option-btn:hover {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }
        .driver-option-btn.active {
            border-color: #f59e0b;
            background-color: #f59e0b;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .recurring-option-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background-color: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        .recurring-option-btn:hover {
            border-color: #059669;
            background-color: #ecfdf5;
        }
        .recurring-option-btn.active {
            border-color: #059669;
            background-color: #059669;
            color: white;
        }
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background-color: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .filter-btn:hover {
            border-color: #8b5cf6;
            background-color: #f3f4f6;
        }
        .filter-btn.active {
            border-color: #8b5cf6;
            background-color: #8b5cf6;
            color: white;
        }
        .transport-time-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
        }
        .calendar-event {
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .calendar-event:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .event-actions {
            position: absolute;
            top: 2px;
            left: 2px;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            gap: 2px;
        }
        .calendar-event:hover .event-actions {
            opacity: 1;
        }
        .action-btn {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        .edit-btn {
            background: #3b82f6;
            color: white;
        }
        .delete-btn {
            background: #ef4444;
            color: white;
        }
        .custom-task-item {
            background: #fef3c7;
            border: 1px solid #f59e0b;
        }
        .weekly-task-item {
            background: #f3f4f6;
            border: 1px solid #6b7280;
        }
        .calendar-event-item {
            background: #ddd6fe;
            border: 1px solid #7c3aed;
        }
        @media (max-width: 768px) {
            .week-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loading" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-lg font-bold text-gray-700">טוען...</p>
        </div>
    </div>

    <!-- Modal for editing events -->
    <div id="edit-event-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">עריכת אירוע</h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" placeholder="פעילות" class="p-3 border rounded-lg" id="edit-event-activity">
                    <input type="date" class="p-3 border rounded-lg" id="edit-event-date">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="time" class="p-3 border rounded-lg" id="edit-event-time" title="שעת האירוע">
                    <div></div>
                </div>
                
                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">משתתפים (בחירה מרובה)</h4>
                    <div id="edit-member-options" class="flex items-center gap-2 flex-wrap">
                        <button type="button" class="transport-option-btn" data-value="טליה" onclick="toggleMember(this, 'edit')">טליה</button>
                        <button type="button" class="transport-option-btn" data-value="שביט" onclick="toggleMember(this, 'edit')">שביט</button>
                        <button type="button" class="transport-option-btn" data-value="שגיא" onclick="toggleMember(this, 'edit')">שגיא</button>
                        <button type="button" class="transport-option-btn" data-value="אביתר" onclick="toggleMember(this, 'edit')">אביתר</button>
                        <button type="button" class="transport-option-btn" data-value="לביא" onclick="toggleMember(this, 'edit')">לביא</button>
                    </div>
                </div>
                
                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">סוג הסעה (בחירה מרובה)</h4>
                    <div id="edit-transport-options" class="flex items-center gap-3 mb-3">
                        <button type="button" class="transport-option-btn" data-value="הלוך" onclick="toggleTransport(this, 'edit')">הלוך</button>
                        <button type="button" class="transport-option-btn" data-value="חזור" onclick="toggleTransport(this, 'edit')">חזור</button>
                        <button type="button" class="transport-option-btn" data-value="לרכבת" onclick="toggleTransport(this, 'edit')">לרכבת</button>
                    </div>
                    
                    <div id="edit-transport-times" class="space-y-3"></div>
                </div>

                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">אירוע חוזר</h4>
                    <div id="edit-recurring-options" class="flex items-center gap-2 flex-wrap">
                        <button type="button" class="recurring-option-btn" data-value="none" onclick="toggleRecurring(this, 'edit')">ללא חזרה</button>
                        <button type="button" class="recurring-option-btn" data-value="daily" onclick="toggleRecurring(this, 'edit')">יומי</button>
                        <button type="button" class="recurring-option-btn" data-value="weekly" onclick="toggleRecurring(this, 'edit')">שבועי</button>
                        <button type="button" class="recurring-option-btn" data-value="monthly" onclick="toggleRecurring(this, 'edit')">חודשי</button>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="saveEditedEvent()" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        שמור שינויים
                    </button>
                    <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        ביטול
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete confirmation modal -->
    <div id="delete-event-modal" class="modal">
        <div class="modal-content max-w-md">
            <div class="text-center">
                <h3 class="text-lg font-bold text-gray-800 mb-4">מחיקת אירוע</h3>
                <p class="text-gray-600 mb-6">האם אתה בטוח שברצונך למחוק את האירוע?</p>
                <div id="recurring-delete-options" class="space-y-3 mb-6" style="display: none;">
                    <p class="text-sm text-gray-600">זהו אירוע חוזר. מה ברצונך למחוק?</p>
                    <div class="space-y-2">
                        <button onclick="deleteEvent('single')" class="w-full px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
                            מחק רק אירוע זה
                        </button>
                        <button onclick="deleteEvent('all')" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                            מחק את כל האירועים החוזרים
                        </button>
                    </div>
                </div>
                <div id="single-delete-options" class="space-y-3">
                    <div class="flex gap-3 justify-center">
                        <button onclick="deleteEvent('single')" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                            מחק
                        </button>
                        <button onclick="closeDeleteModal()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            ביטול
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app" style="display: none;">
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <h1 class="text-xl font-bold text-gray-800">ניהול משפחתי - משפחת פופקו</h1>
                    <div class="flex space-x-2" id="nav-buttons"></div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 py-8" id="main-content"></main>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDOQ29YJkEQqSk9j7FvNsZEwE-xuVh5kQU",
            authDomain: "family-popko.firebaseapp.com",
            databaseURL: "https://family-popko-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "family-popko",
            storageBucket: "family-popko.appspot.com",
            messagingSenderId: "902790940853",
            appId: "1:902790940853:web:23238a2f63612d3ac3d6fc"
        };

        let database;
        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('Firebase initialized successfully');
            } else {
                throw new Error("Firebase library not loaded");
            }
        } catch (error) {
            console.error('Error initializing Firebase:', error);
            const loadingDiv = document.getElementById('loading');
            if (loadingDiv) {
                loadingDiv.innerHTML = `
                    <div class="text-center">
                        <div class="text-red-500 text-xl mb-4">⚠️ שגיאה בחיבור לבסיס הנתונים</div>
                        <p class="text-gray-600">לא ניתן להתחבר לבסיס הנתונים של Firebase</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded">נסה שוב</button>
                    </div>
                `;
            }
        }

        // Global Variables
        let currentView = 'home';
        let currentArrangement = 0;
        let calendar = [];
        let shoppingList = [];
        let customTasks = [];
        let weeklyTasks = {};
        let isInitialLoad = true;
        let editingEventId = null;
        let deletingEventId = null;
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();
        let selectedMemberFilter = null;

        const familyMembers = ['טליה', 'שביט', 'שגיא', 'אביתר', 'לביא'];
        const drivers = ['שביט', 'טליה'];
        const daysOfWeekHebrew = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
        
        // Task arrangements
        const taskArrangements = [
            { 'שגיא': 'פח', 'אביתר': 'מדיח', 'לביא': 'מחזור' },
            { 'שגיא': 'מדיח', 'אביתר': 'מחזור', 'לביא': 'פח' },
            { 'שגיא': 'מחזור', 'אביתר': 'פח', 'לביא': 'מדיח' }
        ];

        // Dog walking schedule
        const dogWalkingSchedule = {
            'ראשון': 'לביא',
            'שני': 'אביתר',
            'שלישי': 'שגיא',
            'רביעי': 'אביתר',
            'חמישי': 'שגיא',
            'שישי': 'לביא ואביתר',
            'שבת': 'שגיא'
        };

        // Member colors
        const memberColors = {
            'שגיא': 'bg-red-100 border-red-300 text-red-800',
            'אביתר': 'bg-blue-100 border-blue-300 text-blue-800',
            'לביא': 'bg-green-100 border-green-300 text-green-800',
            'טליה': 'bg-purple-100 border-purple-300 text-purple-800',
            'שביט': 'bg-orange-100 border-orange-300 text-orange-800'
        };

        // Helper Functions
        function formatDate(date) {
            return new Date(date).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });
        }

        function formatTime(time) {
            if (!time) return '';
            return time;
        }

        function getWeekStartDate(weekOffset = 0) {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysToSunday = dayOfWeek === 0 ? 0 : -dayOfWeek;
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() + daysToSunday + (weekOffset * 7));
            weekStart.setHours(0, 0, 0, 0);
            return weekStart;
        }

        function getWeekKey(weekOffset = 0) {
            const weekStart = getWeekStartDate(weekOffset);
            return `week_${weekStart.getFullYear()}_${weekStart.getMonth() + 1}_${weekStart.getDate()}`;
        }

        function getDayOfWeekFromDate(dateString) {
            const date = new Date(dateString);
            return daysOfWeekHebrew[date.getDay()];
        }

        function initializeWeeklyTasks() {
            const daysOfWeek = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
            let hasChanges = false;
            
            for (let weekOffset = 0; weekOffset < 2; weekOffset++) {
                const weekKey = getWeekKey(weekOffset);
                
                if (!weeklyTasks[weekKey]) {
                    weeklyTasks[weekKey] = {};
                    hasChanges = true;
                    
                    daysOfWeek.forEach(day => {
                        weeklyTasks[weekKey][day] = {};
                        
                        // Add dog walking
                        weeklyTasks[weekKey][day]['טיול עם במבה'] = {
                            assignedTo: dogWalkingSchedule[day],
                            completed: false
                        };
                        
                        // Add chores based on current arrangement
                        const arrangement = taskArrangements[currentArrangement];
                        Object.entries(arrangement).forEach(([child, task]) => {
                            weeklyTasks[weekKey][day][task] = { 
                                assignedTo: child, 
                                completed: false 
                            };
                        });
                    });
                }
            }
            
            if (hasChanges) {
                saveData('weeklyTasks', weeklyTasks);
            }
        }

        // Filter functions
        function setMemberFilter(member) {
            selectedMemberFilter = selectedMemberFilter === member ? null : member;
            updateFilterButtons();
            renderCurrentView();
        }

        function updateFilterButtons() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                const member = btn.dataset.member;
                if (member === selectedMemberFilter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function getFilteredTasks(tasks, dayTasks) {
            if (!selectedMemberFilter) return tasks;
            
            const filtered = {};
            Object.entries(tasks).forEach(([taskName, taskInfo]) => {
                if (taskInfo.assignedTo.includes(selectedMemberFilter)) {
                    filtered[taskName] = taskInfo;
                }
            });
            return filtered;
        }

        function getFilteredCalendarEvents() {
            if (!selectedMemberFilter) return calendar;
            
            return calendar.filter(event => {
                if (Array.isArray(event.members)) {
                    return event.members.includes(selectedMemberFilter);
                }
                return event.member === selectedMemberFilter;
            });
        }

        function getFilteredCustomTasks() {
            if (!selectedMemberFilter) return customTasks;
            
            return customTasks.filter(task => {
                return task.assignedTo === selectedMemberFilter;
            });
        }

        function getCustomTasksForDate(dateString) {
            return getFilteredCustomTasks().filter(task => {
                return task.targetDate === dateString;
            });
        }

        // Transport and Recurring functions
        function toggleTransport(selectedBtn, context = 'new') {
            const isAlreadyActive = selectedBtn.classList.contains('active');

            if (isAlreadyActive) {
                selectedBtn.classList.remove('active');
            } else {
                selectedBtn.classList.add('active');
            }
            
            updateTransportTimes(context);
        }

        function updateTransportTimes(context = 'new') {
            const transportContainerId = context === 'edit' ? 'edit-transport-options' : 'transport-options';
            const transportTimesId = context === 'edit' ? 'edit-transport-times' : 'transport-times';
            
            const selectedTransports = Array.from(document.querySelectorAll(`#${transportContainerId} .active`)).map(btn => btn.dataset.value);
            const transportTimesContainer = document.getElementById(transportTimesId);
            
            if (!transportTimesContainer) return;
            
            transportTimesContainer.innerHTML = '';
            
            selectedTransports.forEach(transport => {
                const timeContainer = document.createElement('div');
                timeContainer.className = 'transport-time-container';
                timeContainer.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-gray-700">${transport}</h5>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input type="time" class="p-2 border rounded-lg" 
                               placeholder="שעה" data-transport="${transport}" data-field="time">
                        <select class="p-2 border rounded-lg" data-transport="${transport}" data-field="driver">
                            <option value="">בחר מסיע</option>
                            ${drivers.map(driver => `<option value="${driver}">${driver}</option>`).join('')}
                        </select>
                    </div>
                `;
                transportTimesContainer.appendChild(timeContainer);
            });
        }

        function toggleMember(selectedBtn, context = 'new') {
            const isAlreadyActive = selectedBtn.classList.contains('active');

            if (isAlreadyActive) {
                selectedBtn.classList.remove('active');
            } else {
                selectedBtn.classList.add('active');
            }
        }

        function toggleRecurring(selectedBtn, context = 'new') {
            const containerId = context === 'edit' ? 'edit-recurring-options' : 'recurring-options';
            const optionsContainer = document.getElementById(containerId);

            optionsContainer.querySelectorAll('.recurring-option-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            selectedBtn.classList.add('active');
        }

        // Recurring event generation
        function generateRecurringEvents(baseEvent, recurringType, endDate = null) {
            const events = [];
            const baseDate = new Date(baseEvent.date);
            const maxEvents = 52;
            let currentDate = new Date(baseDate);
            let count = 0;

            if (!endDate) {
                endDate = new Date();
                endDate.setFullYear(endDate.getFullYear() + 1);
            }

            while (currentDate <= endDate && count < maxEvents) {
                if (count > 0) {
                    const newEvent = {
                        ...baseEvent,
                        id: Date.now() + count,
                        date: currentDate.toISOString().split('T')[0],
                        isRecurring: true,
                        originalEventId: baseEvent.id
                    };
                    events.push(newEvent);
                }

                switch (recurringType) {
                    case 'daily':
                        currentDate.setDate(currentDate.getDate() + 1);
                        break;
                    case 'weekly':
                        currentDate.setDate(currentDate.getDate() + 7);
                        break;
                    case 'monthly':
                        currentDate.setMonth(currentDate.getMonth() + 1);
                        break;
                }
                count++;
            }

            return events;
        }

        // Data processing function
        function processData(snapshot) {
            const data = snapshot.val();
            if (!data) {
                console.log("No data found in Firebase. Initializing empty state.");
                calendar = [];
                shoppingList = [];
                customTasks = [];
                weeklyTasks = {};
            } else {
                calendar = data.calendar || [];
                shoppingList = data.shopping || [];
                customTasks = data.customTasks || [];
                weeklyTasks = data.weeklyTasks || {};
                currentArrangement = data.arrangement || 0;
            }

            initializeWeeklyTasks();

            if (isInitialLoad) {
                renderApp();
                isInitialLoad = false;
            } else {
                renderCurrentView();
            }
        }
        
        // Firebase Functions
        async function saveData(path, data) {
            try {
                if(!database) return;
                await database.ref(`family/${path}`).set(data);
                console.log(`Data saved successfully: ${path}`);
            } catch (error) {
                console.error(`Error saving data: ${path}`, error);
            }
        }

        // Calendar Functions
        async function addCalendarEvent(activity, members, date, time = null, transports = [], recurring = 'none') {
            const baseEvent = {
                id: Date.now(),
                activity: activity,
                members: members,
                date: date,
                time: time,
                recurring: recurring,
                isRecurring: false
            };

            if (transports.length === 0) {
                // No transport - single event
                calendar.push(baseEvent);
                
                if (recurring && recurring !== 'none') {
                    const recurringEvents = generateRecurringEvents(baseEvent, recurring);
                    calendar.push(...recurringEvents);
                }
            } else {
                // Multiple transport events
                transports.forEach((transport, index) => {
                    const newEvent = {
                        ...baseEvent,
                        id: Date.now() + index,
                        activity: `${activity} - ${transport.type}`,
                        transport: transport.type,
                        driver: transport.driver || 'לא הוגדר',
                        transportTime: transport.time || null
                    };
                    calendar.push(newEvent);
                    
                    if (recurring && recurring !== 'none') {
                        const recurringEvents = generateRecurringEvents(newEvent, recurring);
                        calendar.push(...recurringEvents);
                    }
                });
            }

            await saveData('calendar', calendar);
        }

        async function updateCalendarEvent(eventId, activity, members, date, time = null, transports = [], recurring = 'none') {
            const eventIndex = calendar.findIndex(event => event.id === eventId);
            if (eventIndex === -1) return;

            const oldEvent = calendar[eventIndex];
            
            // Remove old recurring events if they exist
            if (oldEvent.recurring && oldEvent.recurring !== 'none') {
                calendar = calendar.filter(event => event.originalEventId !== eventId);
            }

            calendar[eventIndex] = {
                ...oldEvent,
                activity: activity,
                members: members,
                date: date,
                time: time,
                transport: transports.length > 0 ? transports[0].type : null,
                driver: transports.length > 0 ? (transports[0].driver || 'לא הוגדר') : null,
                transportTime: transports.length > 0 ? transports[0].time : null,
                recurring: recurring
            };

            if (recurring && recurring !== 'none') {
                const recurringEvents = generateRecurringEvents(calendar[eventIndex], recurring);
                calendar.push(...recurringEvents);
            }

            await saveData('calendar', calendar);
        }

        async function removeCalendarEvent(id, deleteType = 'single') {
            if (deleteType === 'all') {
                // Delete all recurring events
                calendar = calendar.filter(event => event.id !== id && event.originalEventId !== id);
            } else {
                // Delete only single event
                calendar = calendar.filter(event => event.id !== id);
            }
            await saveData('calendar', calendar);
        }

        // Edit Event Functions
        function openEditModal(eventId) {
            const event = calendar.find(e => e.id === eventId);
            if (!event) return;

            editingEventId = eventId;
            
            document.getElementById('edit-event-activity').value = event.activity;
            document.getElementById('edit-event-date').value = event.date;
            document.getElementById('edit-event-time').value = event.time || '';

            // Clear previous selections
            document.querySelectorAll('#edit-member-options .active, #edit-transport-options .active, #edit-recurring-options .active').forEach(btn => {
                btn.classList.remove('active');
            });

            // Set members
            if (event.members && Array.isArray(event.members)) {
                event.members.forEach(member => {
                    const memberBtn = document.querySelector(`#edit-member-options [data-value="${member}"]`);
                    if (memberBtn) memberBtn.classList.add('active');
                });
            }

            // Set transport
            if (event.transport) {
                const transportBtn = document.querySelector(`#edit-transport-options [data-value="${event.transport}"]`);
                if (transportBtn) {
                    transportBtn.classList.add('active');
                    updateTransportTimes('edit');
                    
                    // Set transport details
                    setTimeout(() => {
                        const driverSelect = document.querySelector(`[data-transport="${event.transport}"][data-field="driver"]`);
                        const timeInput = document.querySelector(`[data-transport="${event.transport}"][data-field="time"]`);
                        if (driverSelect && event.driver) driverSelect.value = event.driver;
                        if (timeInput && event.transportTime) timeInput.value = event.transportTime;
                    }, 100);
                }
            }

            // Set recurring
            const recurringValue = event.recurring || 'none';
            const recurringBtn = document.querySelector(`#edit-recurring-options [data-value="${recurringValue}"]`);
            if (recurringBtn) recurringBtn.classList.add('active');

            document.getElementById('edit-event-modal').classList.add('show');
        }

        function closeEditModal() {
            editingEventId = null;
            document.getElementById('edit-event-modal').classList.remove('show');
            
            document.getElementById('edit-event-activity').value = '';
            document.getElementById('edit-event-date').value = '';
            document.getElementById('edit-event-time').value = '';

            document.querySelectorAll('#edit-member-options .active, #edit-transport-options .active, #edit-recurring-options .active').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById('edit-transport-times').innerHTML = '';
        }

        async function saveEditedEvent() {
            if (!editingEventId) return;

            const activity = document.getElementById('edit-event-activity').value;
            const date = document.getElementById('edit-event-date').value;
            const time = document.getElementById('edit-event-time').value;

            const selectedMembers = Array.from(document.querySelectorAll('#edit-member-options .active')).map(btn => btn.dataset.value);
            const selectedTransports = Array.from(document.querySelectorAll('#edit-transport-options .active')).map(btn => {
                const transportType = btn.dataset.value;
                const driverSelect = document.querySelector(`[data-transport="${transportType}"][data-field="driver"]`);
                const timeInput = document.querySelector(`[data-transport="${transportType}"][data-field="time"]`);
                
                return {
                    type: transportType,
                    driver: driverSelect ? driverSelect.value : null,
                    time: timeInput ? timeInput.value : null
                };
            });
            const selectedRecurring = document.querySelector('#edit-recurring-options .active')?.dataset.value || 'none';

            if (activity && selectedMembers.length > 0 && date) {
                await updateCalendarEvent(editingEventId, activity, selectedMembers, date, time, selectedTransports, selectedRecurring);
                closeEditModal();
            }
        }

        // Delete Event Functions
        function openDeleteModal(eventId, event) {
            deletingEventId = eventId;
            const isRecurring = event.recurring && event.recurring !== 'none';
            
            if (isRecurring || event.isRecurring) {
                document.getElementById('recurring-delete-options').style.display = 'block';
                document.getElementById('single-delete-options').style.display = 'none';
            } else {
                document.getElementById('recurring-delete-options').style.display = 'none';
                document.getElementById('single-delete-options').style.display = 'block';
            }
            
            document.getElementById('delete-event-modal').classList.add('show');
        }

        function closeDeleteModal() {
            deletingEventId = null;
            document.getElementById('delete-event-modal').classList.remove('show');
        }

        async function deleteEvent(type) {
            if (!deletingEventId) return;
            
            await removeCalendarEvent(deletingEventId, type);
            closeDeleteModal();
            renderCurrentView();
        }

        // Weekly tasks functions
        async function toggleWeeklyTask(weekKey, day, task) {
            if (weeklyTasks[weekKey] && weeklyTasks[weekKey][day] && weeklyTasks[weekKey][day][task]) {
                weeklyTasks[weekKey][day][task].completed = !weeklyTasks[weekKey][day][task].completed;
                await saveData('weeklyTasks', weeklyTasks);
                renderCurrentView();
            }
        }

        async function changeArrangement() {
            currentArrangement = (currentArrangement + 1) % 3;
            await saveData('arrangement', currentArrangement);
            
            weeklyTasks = {};
            initializeWeeklyTasks();
            renderCurrentView();
        }

        // Other data functions
        async function addShoppingItem(item, addedBy) {
            const newItem = {
                id: Date.now(),
                item: item,
                addedBy: addedBy || 'לא ידוע',
                completed: false,
                dateAdded: new Date().toISOString()
            };
            shoppingList.push(newItem);
            await saveData('shopping', shoppingList);
        }

        async function toggleShoppingItem(id) {
            const item = shoppingList.find(item => item.id === id);
            if (item) {
                item.completed = !item.completed;
                await saveData('shopping', shoppingList);
            }
        }

        async function removeShoppingItem(id) {
            shoppingList = shoppingList.filter(item => item.id !== id);
            await saveData('shopping', shoppingList);
        }

        async function addCustomTask(title, assignedTo, targetDate) {
            const newTask = {
                id: Date.now(),
                title: title,
                assignedTo: assignedTo,
                completed: false,
                dateCreated: new Date().toISOString(),
                targetDate: targetDate || null
            };
            customTasks.push(newTask);
            await saveData('customTasks', customTasks);
        }

        async function toggleCustomTask(id) {
            const task = customTasks.find(task => task.id === id);
            if (task) {
                task.completed = !task.completed;
                await saveData('customTasks', customTasks);
            }
        }

        async function removeCustomTask(id) {
            customTasks = customTasks.filter(task => task.id !== id);
            await saveData('customTasks', customTasks);
        }

        // UI Functions
        function setCurrentView(view) {
            currentView = view;
            renderCurrentView();
            renderNavigation();
        }

        function renderNavigation() {
            const navButtons = document.getElementById('nav-buttons');
            navButtons.innerHTML = `
                <button onclick="setCurrentView('home')" class="px-4 py-2 rounded-lg flex items-center space-x-1 ${currentView === 'home' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="home" class="w-4 h-4"></i>
                    <span>בית</span>
                </button>
                <button onclick="setCurrentView('calendar')" class="px-4 py-2 rounded-lg flex items-center space-x-1 ${currentView === 'calendar' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span>לוז</span>
                </button>
                <button onclick="setCurrentView('shopping')" class="px-4 py-2 rounded-lg flex items-center space-x-1 ${currentView === 'shopping' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                    <span>קניות</span>
                </button>
                <button onclick="setCurrentView('custom-tasks')" class="px-4 py-2 rounded-lg flex items-center space-x-1 ${currentView === 'custom-tasks' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>משימות</span>
                </button>
            `;
            lucide.createIcons();
        }

        function renderHomeView() {
            const pendingShoppingItems = shoppingList.filter(item => !item.completed).length;
            const currentArrangementData = taskArrangements[currentArrangement];
            
            // Get today's events with correct date handling
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const todayEvents = getFilteredCalendarEvents().filter(event => event.date === todayStr);
            
            const getWeekTasksHTML = (weekOffset) => {
                const weekKey = getWeekKey(weekOffset);
                const weekStart = getWeekStartDate(weekOffset);
                const weekTasks = weeklyTasks[weekKey] || {};
                
                return `
                    <div class="grid grid-cols-1 md:grid-cols-7 gap-3">
                        ${daysOfWeekHebrew.map(day => {
                            const dayTasks = weekTasks[day] || {};
                            const filteredTasks = getFilteredTasks(dayTasks, dayTasks);
                            const dayDate = new Date(weekStart);
                            const dayIndex = daysOfWeekHebrew.indexOf(day);
                            dayDate.setDate(weekStart.getDate() + dayIndex);
                            const isToday = dayDate.toDateString() === today.toDateString();
                            const dateStr = dayDate.toISOString().split('T')[0];
                            const dayEvents = getFilteredCalendarEvents().filter(event => event.date === dateStr);
                            const dayCustomTasks = getCustomTasksForDate(dateStr);
                            
                            return `
                                <div class="bg-white p-4 rounded-lg shadow ${isToday ? 'border-2 border-blue-400' : 'border border-gray-200'}">
                                    <div class="text-center mb-3">
                                        <h4 class="font-bold text-gray-800">${day}</h4>
                                        <p class="text-xs text-gray-500">${formatDate(dayDate)}</p>
                                        ${isToday ? '<p class="text-xs text-blue-600 font-bold">היום</p>' : ''}
                                    </div>
                                    
                                    <div class="space-y-2">
                                        ${Object.entries(filteredTasks).map(([task, taskInfo]) => `
                                            <div class="p-2 rounded text-xs weekly-task-item ${taskInfo.completed ? 'bg-green-50 border border-green-200' : ''}">
                                                <div class="flex items-center justify-between">
                                                    <button onclick="toggleWeeklyTask('${weekKey}', '${day}', '${task.replace(/'/g, "\\'")}')">
                                                        <i data-lucide="${taskInfo.completed ? 'check-circle' : 'circle'}" 
                                                           class="w-3 h-3 ${taskInfo.completed ? 'text-green-600' : 'text-gray-400 hover:text-green-500'}"></i>
                                                    </button>
                                                    <div class="flex-1 mr-2">
                                                        <div class="${taskInfo.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${task}</div>
                                                        <div class="text-xs ${memberColors[taskInfo.assignedTo.split(' ')[0]] || 'text-blue-600'} rounded px-1">${taskInfo.assignedTo}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                        
                                        ${dayEvents.map(event => `
                                            <div class="p-2 rounded text-xs calendar-event-item">
                                                <div class="font-medium text-indigo-800">${event.activity}</div>
                                                ${event.time ? `<div class="text-xs text-indigo-600">⏰ ${formatTime(event.time)}</div>` : ''}
                                                ${event.transport ? `<div class="text-xs text-indigo-600">🚗 ${event.transport}</div>` : ''}
                                                <div class="text-xs text-gray-600">👥 ${Array.isArray(event.members) ? event.members.join(', ') : event.member || ''}</div>
                                            </div>
                                        `).join('')}
                                        
                                        ${dayCustomTasks.map(task => `
                                            <div class="p-2 rounded text-xs custom-task-item">
                                                <div class="flex items-center justify-between">
                                                    <button onclick="toggleCustomTask(${task.id})">
                                                        <i data-lucide="${task.completed ? 'check-circle' : 'circle'}" 
                                                           class="w-3 h-3 ${task.completed ? 'text-green-600' : 'text-orange-400 hover:text-orange-500'}"></i>
                                                    </button>
                                                    <div class="flex-1 mr-2">
                                                        <div class="${task.completed ? 'line-through text-gray-500' : 'text-orange-800'} font-medium">📋 ${task.title}</div>
                                                        <div class="text-xs ${memberColors[task.assignedTo] || 'text-orange-600'} rounded px-1">${task.assignedTo}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            };

            return `
                <div class="space-y-6">
                    <!-- Member Filter -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-bold text-gray-800 mb-3">פילטר לפי בן משפחה</h3>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="setMemberFilter(null)" class="filter-btn ${!selectedMemberFilter ? 'active' : ''}" data-member="">
                                הכל
                            </button>
                            ${familyMembers.map(member => `
                                <button onclick="setMemberFilter('${member}')" class="filter-btn ${selectedMemberFilter === member ? 'active' : ''}" data-member="${member}">
                                    ${member}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Today's Events -->
                    ${todayEvents.length > 0 ? `
                        <div class="bg-indigo-50 border border-indigo-200 p-4 rounded-lg">
                            <h3 class="text-lg font-bold text-indigo-800 mb-3">אירועי היום (${formatDate(today)})</h3>
                            <div class="space-y-2">
                                ${todayEvents.map(event => `
                                    <div class="p-3 bg-white rounded border border-indigo-200">
                                        <div class="font-medium text-indigo-800">${event.activity}</div>
                                        ${event.time ? `<div class="text-sm text-indigo-600">⏰ ${formatTime(event.time)}</div>` : ''}
                                        ${event.transport ? `<div class="text-sm text-indigo-600">🚗 ${event.transport} ${event.transportTime ? `- ${formatTime(event.transportTime)}` : ''}</div>` : ''}
                                        <div class="text-sm text-gray-600">👥 ${Array.isArray(event.members) ? event.members.join(', ') : event.member || ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Today's Custom Tasks -->
                    ${getCustomTasksForDate(todayStr).length > 0 ? `
                        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                            <h3 class="text-lg font-bold text-yellow-800 mb-3">משימות ליום (${formatDate(today)})</h3>
                            <div class="space-y-2">
                                ${getCustomTasksForDate(todayStr).map(task => `
                                    <div class="p-3 bg-white rounded border border-yellow-200">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <button onclick="toggleCustomTask(${task.id})">
                                                    <i data-lucide="${task.completed ? 'check-circle' : 'circle'}" 
                                                       class="w-5 h-5 ${task.completed ? 'text-green-600' : 'text-yellow-500'}"></i>
                                                </button>
                                                <div>
                                                    <div class="font-medium ${task.completed ? 'line-through text-gray-500' : 'text-yellow-800'}">📋 ${task.title}</div>
                                                    <div class="text-sm text-gray-600">אחראי: ${task.assignedTo}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="bg-blue-50 p-4 rounded-lg flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-bold text-blue-800">סידור משימות #${currentArrangement + 1}</h2>
                            <div class="text-sm text-blue-700 mt-1">
                                ${Object.entries(currentArrangementData).map(([child, task]) => 
                                    `<span class="inline-block ml-4 px-2 py-1 rounded ${memberColors[child]}">${child}: ${task}</span>`
                                ).join('')}
                            </div>
                        </div>
                        <button onclick="changeArrangement()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            סידור הבא
                        </button>
                    </div>

                    ${pendingShoppingItems > 0 ? `
                        <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg cursor-pointer" onclick="setCurrentView('shopping')">
                            <div class="flex items-center">
                                <i data-lucide="shopping-cart" class="w-5 h-5 text-orange-600 ml-2"></i>
                                <span class="font-medium text-orange-800">
                                    יש ${pendingShoppingItems} פריטים ברשימת הקניות
                                </span>
                            </div>
                        </div>
                    ` : ''}

                    <div class="week-header">
                        <h3 class="text-xl font-bold">השבוע הנוכחי</h3>
                        <p class="text-sm opacity-90">${formatDate(getWeekStartDate(0))} - ${formatDate(new Date(getWeekStartDate(0).getTime() + 6 * 24 * 60 * 60 * 1000))}</p>
                        ${selectedMemberFilter ? `<p class="text-sm opacity-90">מציג משימות של: ${selectedMemberFilter}</p>` : ''}
                        <div class="text-xs mt-2 space-x-4">
                            <span class="inline-flex items-center">
                                <div class="w-3 h-3 weekly-task-item rounded mr-1"></div>
                                משימות שבועיות
                            </span>
                            <span class="inline-flex items-center">
                                <div class="w-3 h-3 calendar-event-item rounded mr-1"></div>
                                אירועי לוח שנה
                            </span>
                            <span class="inline-flex items-center">
                                <div class="w-3 h-3 custom-task-item rounded mr-1"></div>
                                משימות מותאמות אישית
                            </span>
                        </div>
                    </div>
                    ${getWeekTasksHTML(0)}

                    <div class="week-header">
                        <h3 class="text-xl font-bold">השבוע הבא</h3>
                        <p class="text-sm opacity-90">${formatDate(getWeekStartDate(1))} - ${formatDate(new Date(getWeekStartDate(1).getTime() + 6 * 24 * 60 * 60 * 1000))}</p>
                        ${selectedMemberFilter ? `<p class="text-sm opacity-90">מציג משימות של: ${selectedMemberFilter}</p>` : ''}
                    </div>
                    ${getWeekTasksHTML(1)}
                </div>
            `;
        }

        function renderCalendarView() {
            const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
            
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
            const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const monthEvents = getFilteredCalendarEvents().filter(event => {
                const eventDate = new Date(event.date);
                return eventDate.getMonth() === currentCalendarMonth && eventDate.getFullYear() === currentCalendarYear;
            });

            const getEventsForDay = (day) => {
                const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                return monthEvents.filter(event => event.date === dateStr);
            };

            const generateCalendar = () => {
                let calendar = [];
                let week = [];
                
                for (let i = 0; i < startingDayOfWeek; i++) {
                    week.push('<div class="h-24 bg-gray-50"></div>');
                }
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEvents = getEventsForDay(day);
                    const today = new Date();
                    const isToday = today.getDate() === day && today.getMonth() === currentCalendarMonth && today.getFullYear() === currentCalendarYear;
                    
                    week.push(`
                        <div class="h-24 border border-gray-200 p-1 ${isToday ? 'bg-blue-50 border-blue-300' : 'bg-white'}">
                            <div class="text-sm font-medium ${isToday ? 'text-blue-700' : 'text-gray-700'}">${day}</div>
                            <div class="mt-1 space-y-1 overflow-hidden">
                                ${dayEvents.slice(0, 2).map(event => {
                                    const firstMember = Array.isArray(event.members) && event.members.length > 0 ? event.members[0] : event.member || '';
                                    const memberColor = memberColors[firstMember] || 'bg-gray-100 border-gray-300 text-gray-800';
                                    const eventObj = JSON.stringify(event).replace(/"/g, '&quot;');
                                    return `
                                        <div class="text-xs p-1 rounded ${memberColor} truncate calendar-event" onclick="openEditModal(${event.id})" title="${event.activity}">
                                            <div class="event-actions">
                                                <button class="action-btn edit-btn" onclick="event.stopPropagation(); openEditModal(${event.id})" title="ערוך">
                                                    ✏️
                                                </button>
                                                <button class="action-btn delete-btn" onclick="event.stopPropagation(); openDeleteModal(${event.id}, ${eventObj})" title="מחק">
                                                    🗑️
                                                </button>
                                            </div>
                                            ${event.activity.substring(0, 15)}${event.activity.length > 15 ? '...' : ''}
                                            ${event.time ? `<br>⏰ ${formatTime(event.time)}` : ''}
                                        </div>
                                    `;
                                }).join('')}
                                ${dayEvents.length > 2 ? `<div class="text-xs text-gray-500">+${dayEvents.length - 2} עוד</div>` : ''}
                            </div>
                        </div>
                    `);
                    
                    if (week.length === 7) {
                        calendar.push(`<div class="grid grid-cols-7 gap-1">${week.join('')}</div>`);
                        week = [];
                    }
                }
                
                while (week.length < 7 && week.length > 0) {
                    week.push('<div class="h-24 bg-gray-50"></div>');
                }
                if (week.length === 7) {
                    calendar.push(`<div class="grid grid-cols-7 gap-1">${week.join('')}</div>`);
                }
                
                return calendar.join('');
            };

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">לוח משפחתי</h2>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">הוספת אירוע</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input type="text" placeholder="פעילות" class="p-3 border rounded-lg" id="new-event-activity">
                            <input type="date" class="p-3 border rounded-lg" id="new-event-date">
                            <input type="time" class="p-3 border rounded-lg" id="new-event-time" title="שעת האירוע">
                        </div>

                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">משתתפים (בחירה מרובה)</h4>
                            <div id="member-options" class="flex items-center gap-2 flex-wrap">
                                ${familyMembers.map(member => `
                                    <button type="button" class="transport-option-btn" data-value="${member}" onclick="toggleMember(this)">${member}</button>
                                `).join('')}
                            </div>
                        </div>

                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">סוג הסעה (בחירה מרובה)</h4>
                            <div id="transport-options" class="flex items-center gap-3 mb-3">
                                <button type="button" class="transport-option-btn" data-value="הלוך" onclick="toggleTransport(this)">הלוך</button>
                                <button type="button" class="transport-option-btn" data-value="חזור" onclick="toggleTransport(this)">חזור</button>
                                <button type="button" class="transport-option-btn" data-value="לרכבת" onclick="toggleTransport(this)">לרכבת</button>
                            </div>
                            
                            <div id="transport-times" class="space-y-3"></div>
                        </div>

                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">אירוע חוזר</h4>
                            <div id="recurring-options" class="flex items-center gap-2 flex-wrap">
                                <button type="button" class="recurring-option-btn active" data-value="none" onclick="toggleRecurring(this)">ללא חזרה</button>
                                <button type="button" class="recurring-option-btn" data-value="daily" onclick="toggleRecurring(this)">יומי</button>
                                <button type="button" class="recurring-option-btn" data-value="weekly" onclick="toggleRecurring(this)">שבועי</button>
                                <button type="button" class="recurring-option-btn" data-value="monthly" onclick="toggleRecurring(this)">חודשי</button>
                            </div>
                        </div>
                        
                        <button onclick="addNewCalendarEvent()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            הוסף אירוע
                        </button>
                    </div>

                    <!-- Calendar Display -->
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="changeCalendarMonth(-1)" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </button>
                            <h3 class="text-xl font-bold text-gray-800">${monthNames[currentCalendarMonth]} ${currentCalendarYear}</h3>
                            <button onclick="changeCalendarMonth(1)" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-7 gap-1 mb-2">
                            ${['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'].map(day => 
                                `<div class="text-center font-medium text-gray-600 py-2">${day}</div>`
                            ).join('')}
                        </div>
                        
                        ${generateCalendar()}
                    </div>
                </div>
            `;
        }

        function changeCalendarMonth(direction) {
            currentCalendarMonth += direction;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            renderCurrentView();
        }

        function renderShoppingView() {
           return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">רשימת קניות</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" placeholder="מה לקנות?" class="p-3 border rounded-lg" id="new-item" onkeypress="if(event.key === 'Enter') addNewShoppingItem()">
                            <select class="p-3 border rounded-lg" id="new-item-by">
                                <option value="">מי מבקש?</option>
                                ${familyMembers.map(member => `<option value="${member}">${member}</option>`).join('')}
                            </select>
                        </div>
                        <button onclick="addNewShoppingItem()" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600">
                            הוסף לרשימה
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-lg font-bold text-red-600 mb-4">
                                לקנות (${shoppingList.filter(item => !item.completed).length})
                            </h3>
                            <div class="space-y-2">
                                ${shoppingList.filter(item => !item.completed).map(item => `
                                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                        <div class="flex items-center space-x-2">
                                            <button onclick="toggleShoppingItem(${item.id})">
                                                <i data-lucide="circle" class="w-5 h-5 text-red-500"></i>
                                            </button>
                                            <div>
                                                <div class="font-medium">${item.item}</div>
                                                <div class="text-sm text-gray-600">הוסיף/ה: ${item.addedBy}</div>
                                            </div>
                                        </div>
                                        <button onclick="removeShoppingItem(${item.id})">
                                            <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-lg font-bold text-green-600 mb-4">
                                נקנו (${shoppingList.filter(item => item.completed).length})
                            </h3>
                            <div class="space-y-2">
                                ${shoppingList.filter(item => item.completed).map(item => `
                                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                        <div class="flex items-center space-x-2">
                                             <button onclick="toggleShoppingItem(${item.id})">
                                                <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                                             </button>
                                            <div>
                                                <div class="font-medium line-through text-gray-500">${item.item}</div>
                                                <div class="text-sm text-gray-500">הוסיף/ה: ${item.addedBy}</div>
                                            </div>
                                        </div>
                                        <button onclick="removeShoppingItem(${item.id})">
                                            <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCustomTasksView() {
            const currentArrangementData = taskArrangements[currentArrangement];
            
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">ניהול משימות</h2>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">סידור משימות שבועיות נוכחי #${currentArrangement + 1}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-medium text-gray-700 mb-3">משימות בית</h4>
                                <div class="space-y-2">
                                    ${Object.entries(currentArrangementData).map(([child, task]) => `
                                        <div class="p-3 rounded-lg ${memberColors[child]}">
                                            <span class="font-medium">${child}</span> - ${task}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-medium text-gray-700 mb-3">טיולים עם במבה</h4>
                                <div class="space-y-2">
                                    ${Object.entries(dogWalkingSchedule).map(([day, person]) => `
                                        <div class="p-2 rounded-lg bg-gray-50 border border-gray-200 text-sm">
                                            <span class="font-medium">${day}</span> - 
                                            <span class="${memberColors[person.split(' ')[0]] || 'text-gray-700'}">${person}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="changeArrangement()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            עבור לסידור הבא (#${((currentArrangement + 1) % 3) + 1})
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">הוספת משימה חד פעמית</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input type="text" placeholder="כותרת המשימה" class="p-3 border rounded-lg" id="new-task-title">
                            <select class="p-3 border rounded-lg" id="new-task-assignee">
                                <option value="">למי להקצות?</option>
                                ${familyMembers.map(member => `<option value="${member}">${member}</option>`).join('')}
                            </select>
                            <input type="date" class="p-3 border rounded-lg" id="new-task-target-full" title="תאריך יעד">
                        </div>
                        <button onclick="addNewCustomTask()" class="px-6 py-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">
                            הוסף משימה
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            משימות פעילות (${customTasks.filter(task => !task.completed).length})
                        </h3>
                        <div class="space-y-3">
                            ${customTasks.filter(task => !task.completed).map(task => `
                                <div class="p-4 rounded-lg border bg-gray-50 border-gray-200">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <button onclick="toggleCustomTask(${task.id})">
                                                <i data-lucide="circle" class="w-6 h-6 text-gray-400 hover:text-green-500"></i>
                                            </button>
                                            <div>
                                                <div class="font-medium text-lg">${task.title}</div>
                                                <div class="text-sm text-gray-600">
                                                    אחראי: <span class="${memberColors[task.assignedTo] || 'text-gray-700'}">${task.assignedTo}</span>
                                                    ${task.targetDate ? `• יעד: ${new Date(task.targetDate).toLocaleDateString('he-IL')}` : ''}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="removeCustomTask(${task.id})">
                                                <i data-lucide="trash-2" class="w-5 h-5 text-red-500"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-green-600 mb-4">
                            משימות שבוצעו (${customTasks.filter(task => task.completed).length})
                        </h3>
                        <div class="space-y-2">
                            ${customTasks.filter(task => task.completed).map(task => `
                                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                    <div class="flex items-center space-x-2">
                                         <button onclick="toggleCustomTask(${task.id})">
                                            <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                                         </button>
                                        <div>
                                            <div class="font-medium line-through text-gray-500">${task.title}</div>
                                            <div class="text-sm text-gray-500">${task.assignedTo}</div>
                                        </div>
                                    </div>
                                    <button onclick="removeCustomTask(${task.id})">
                                        <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderCurrentView() {
            let content = '';
            switch (currentView) {
                case 'home': content = renderHomeView(); break;
                case 'calendar': content = renderCalendarView(); break;
                case 'shopping': content = renderShoppingView(); break;
                case 'custom-tasks': content = renderCustomTasksView(); break;
                default: content = renderHomeView();
            }
            document.getElementById('main-content').innerHTML = content;
            lucide.createIcons();
        }

        function renderApp() {
            renderNavigation();
            renderCurrentView();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        }
        
        // Helper UI Functions
        function addNewShoppingItem() {
            const itemInput = document.getElementById('new-item');
            const bySelect = document.getElementById('new-item-by');
            if (itemInput.value.trim() && bySelect.value) {
                addShoppingItem(itemInput.value.trim(), bySelect.value);
                itemInput.value = '';
                bySelect.value = '';
            }
        }
        
        function addNewCalendarEvent() {
            const activity = document.getElementById('new-event-activity');
            const date = document.getElementById('new-event-date');
            const time = document.getElementById('new-event-time');
            
            const selectedMembers = Array.from(document.querySelectorAll('#member-options .active')).map(btn => btn.dataset.value);
            const selectedTransports = Array.from(document.querySelectorAll('#transport-options .active')).map(btn => {
                const transportType = btn.dataset.value;
                const driverSelect = document.querySelector(`[data-transport="${transportType}"][data-field="driver"]`);
                const timeInput = document.querySelector(`[data-transport="${transportType}"][data-field="time"]`);
                
                return {
                    type: transportType,
                    driver: driverSelect ? driverSelect.value : null,
                    time: timeInput ? timeInput.value : null
                };
            });
            const selectedRecurring = document.querySelector('#recurring-options .active')?.dataset.value || 'none';

            if (activity.value && selectedMembers.length > 0 && date.value) {
                addCalendarEvent(activity.value, selectedMembers, date.value, time.value, selectedTransports, selectedRecurring);
                
                // Reset form
                activity.value = '';
                date.value = '';
                time.value = '';
                
                // Reset all buttons
                document.querySelectorAll('#member-options .active, #transport-options .active').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Reset recurring to "none"
                document.querySelectorAll('#recurring-options .active').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector('#recurring-options [data-value="none"]').classList.add('active');
                
                // Clear transport times
                document.getElementById('transport-times').innerHTML = '';
            }
        }

        function addNewCustomTask() {
            const title = document.getElementById('new-task-title');
            const assignee = document.getElementById('new-task-assignee');
            const target = document.getElementById('new-task-target-full');
            
            if (title.value && assignee.value) {
                addCustomTask(title.value, assignee.value, target.value);
                title.value = '';
                assignee.value = '';
                target.value = '';
            }
        }
        
        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing application...');
            
            if (!database) {
                 console.error('Database not initialized. Halting execution.');
                 return;
            }

            // Listen for real-time updates from Firebase
            try {
                database.ref('family').on('value', (snapshot) => {
                    console.log('Real-time update from database received.');
                    processData(snapshot);
                }, (error) => {
                    console.error('Error listening for real-time updates:', error);
                });
            } catch (error) {
                console.error('Error setting up real-time listener:', error);
            }
        });
    </script>
</body>
</html>