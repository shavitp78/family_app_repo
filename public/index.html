<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>משפחת פופקו</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { direction: rtl; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-lg font-bold text-gray-700">טוען...</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" style="display: none;">
        <!-- Navigation -->
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <h1 class="text-xl font-bold text-gray-800">ניהול משפחתי - משפחת פופקו</h1>
                    <div class="flex space-x-2" id="nav-buttons"></div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8" id="main-content"></main>
    </div>

    <script>
        // Firebase Configuration - REPLACE WITH YOUR CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDOQ29YJkEQqSk9j7FvNsZEwE-xuVh5kQU",
            authDomain: "family-popko.firebaseapp.com",
            projectId: "family-popko",
            storageBucket: "family-popko.appspot.com",
            messagingSenderId: "902790940853",
            appId: "1:902790940853:web:23238a2f63612d3ac3d6fc"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global Variables
        let currentView = 'home';
        let currentArrangement = 0;
        let tasks = {};
        let calendar = [];
        let shoppingList = [];
        let customTasks = [];

        const familyMembers = ['טליה', 'שביט', 'שגיא', 'אביתר', 'לביא'];
        
        const dogWalkingSchedule = {
            'ראשון': 'לביא',
            'שני': 'אביתר',
            'שלישי': 'שגיא',
            'רביעי': 'אביתר',
            'חמישי': 'שגיא',
            'שישי': 'לביא ואביתר',
            'שבת': 'שגיא'
        };

        const taskArrangements = [
            { 'שגיא': 'פח', 'אביתר': 'מדיח', 'לביא': 'מחזור' },
            { 'שגיא': 'מדיח', 'אביתר': 'מחזור', 'לביא': 'פח' },
            { 'שגיא': 'מחזור', 'אביתר': 'פח', 'לביא': 'מדיח' }
        ];

        // Helper Functions
        function getCurrentDay() {
            const today = new Date();
            const dayIndex = today.getDay();
            const daysOfWeek = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
            return daysOfWeek[dayIndex];
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('he-IL');
        }

        function getDaysInfo(task) {
            const today = new Date();
            const created = new Date(task.dateCreated);
            const daysOpen = Math.ceil(Math.abs(today - created) / (1000 * 60 * 60 * 24));
            
            let daysUntilTarget = null;
            let isOverdue = false;
            
            if (task.targetDate) {
                const target = new Date(task.targetDate);
                daysUntilTarget = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                isOverdue = daysUntilTarget < 0;
            }
            
            return { daysOpen, daysUntilTarget, isOverdue };
        }

        function getTaskColor(task) {
            const { daysOpen, daysUntilTarget, isOverdue } = getDaysInfo(task);
            
            if (isOverdue) return 'bg-red-100 border-red-300';
            if (daysUntilTarget !== null && daysUntilTarget <= 1) return 'bg-orange-100 border-orange-300';
            if (daysUntilTarget !== null) return 'bg-blue-50 border-blue-200';
            if (daysOpen > 6) return 'bg-red-50 border-red-200';
            if (daysOpen > 3) return 'bg-yellow-50 border-yellow-200';
            return 'bg-gray-50 border-gray-200';
        }

        function getTaskLabel(task) {
            const { daysOpen, daysUntilTarget, isOverdue } = getDaysInfo(task);
            
            if (isOverdue) return `איחור! ${Math.abs(daysUntilTarget)} ימים`;
            if (daysUntilTarget !== null && daysUntilTarget <= 1) return `דחוף! ${daysUntilTarget} ימים`;
            if (daysUntilTarget !== null) return `${daysUntilTarget} ימים ליעד`;
            if (daysOpen > 6) return `מאחר! ${daysOpen} ימים`;
            if (daysOpen > 3) return `דחוף! ${daysOpen} ימים`;
            return `${daysOpen} ימים`;
        }

        // Firebase Functions
        async function loadData() {
            try {
                const [tasksDoc, calendarDoc, shoppingDoc, customTasksDoc, arrangementDoc] = await Promise.all([
                    db.collection('family').doc('tasks').get(),
                    db.collection('family').doc('calendar').get(),
                    db.collection('family').doc('shopping').get(),
                    db.collection('family').doc('customTasks').get(),
                    db.collection('family').doc('arrangement').get()
                ]);

                if (tasksDoc.exists) tasks = tasksDoc.data().data || {};
                if (calendarDoc.exists) calendar = calendarDoc.data().events || [];
                if (shoppingDoc.exists) shoppingList = shoppingDoc.data().items || [];
                if (customTasksDoc.exists) customTasks = customTasksDoc.data().tasks || [];
                if (arrangementDoc.exists) currentArrangement = arrangementDoc.data().current || 0;

                initializeTasks();
                renderApp();
            } catch (error) {
                console.error('שגיאה בטעינת נתונים:', error);
                initializeTasks();
                renderApp();
            }
        }

        async function saveData(collection, data) {
            try {
                await db.collection('family').doc(collection).set(data);
            } catch (error) {
                console.error('שגיאה בשמירת נתונים:', error);
            }
        }

        function initializeTasks() {
            if (Object.keys(tasks).length > 0) return;
            
            const daysOfWeek = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
            const weekTasks = {};
            
            daysOfWeek.forEach(day => {
                weekTasks[day] = {};
                weekTasks[day]['טיול עם במבה'] = {
                    assignedTo: dogWalkingSchedule[day],
                    completed: false
                };
                
                const arrangement = taskArrangements[currentArrangement];
                Object.entries(arrangement).forEach(([child, task]) => {
                    weekTasks[day][task] = { assignedTo: child, completed: false };
                });
            });
            
            tasks = weekTasks;
            saveData('tasks', { data: tasks });
        }

        // Data Update Functions
        async function toggleTaskComplete(day, task) {
            tasks[day][task].completed = !tasks[day][task].completed;
            await saveData('tasks', { data: tasks });
            renderCurrentView();
        }

        async function addShoppingItem(item, addedBy) {
            const newItem = {
                id: Date.now(),
                item: item,
                addedBy: addedBy || 'לא ידוע',
                completed: false,
                dateAdded: new Date().toISOString()
            };
            shoppingList.push(newItem);
            await saveData('shopping', { items: shoppingList });
            renderCurrentView();
        }

        async function toggleShoppingItem(id) {
            const item = shoppingList.find(item => item.id === id);
            if (item) {
                item.completed = !item.completed;
                await saveData('shopping', { items: shoppingList });
                renderCurrentView();
            }
        }

        async function removeShoppingItem(id) {
            shoppingList = shoppingList.filter(item => item.id !== id);
            await saveData('shopping', { items: shoppingList });
            renderCurrentView();
        }

        async function addCustomTask(title, assignedTo, targetDate) {
            const newTask = {
                id: Date.now(),
                title: title,
                assignedTo: assignedTo,
                completed: false,
                dateCreated: new Date().toISOString(),
                targetDate: targetDate || null
            };
            customTasks.push(newTask);
            await saveData('customTasks', { tasks: customTasks });
            renderCurrentView();
        }

        async function toggleCustomTask(id) {
            const task = customTasks.find(task => task.id === id);
            if (task) {
                task.completed = !task.completed;
                await saveData('customTasks', { tasks: customTasks });
                renderCurrentView();
            }
        }

        async function removeCustomTask(id) {
            customTasks = customTasks.filter(task => task.id !== id);
            await saveData('customTasks', { tasks: customTasks });
            renderCurrentView();
        }

        async function addCalendarEvent(activity, member, date, time, transport = false) {
            const newEvent = {
                id: Date.now(),
                activity: activity,
                member: member,
                date: date,
                time: time,
                transport: transport
            };
            calendar.push(newEvent);
            await saveData('calendar', { events: calendar });
            renderCurrentView();
        }

        async function removeCalendarEvent(id) {
            calendar = calendar.filter(event => event.id !== id);
            await saveData('calendar', { events: calendar });
            renderCurrentView();
        }

        async function changeArrangement() {
            currentArrangement = (currentArrangement + 1) % 3;
            await saveData('arrangement', { current: currentArrangement });
            initializeTasks();
            renderCurrentView();
        }

        // UI Functions
        function setCurrentView(view) {
            currentView = view;
            renderApp();
        }

        function renderNavigation() {
            const navButtons = document.getElementById('nav-buttons');
            navButtons.innerHTML = `
                <button onclick="setCurrentView('home')" class="px-4 py-2 rounded-lg flex items-center space-x-1 ${currentView === 'home' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="home" class="w-4 h-4"></i>
                    <span>בית</span>
                </button>
                <button onclick="setCurrentView('calendar')" class="px-4 py-2 rounded-lg flex items-center space-x-1 ${currentView === 'calendar' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span>לוז</span>
                </button>
                <button onclick="setCurrentView('shopping')" class="px-4 py-2 rounded-lg flex items-center space-x-1 ${currentView === 'shopping' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                    <span>קניות</span>
                </button>
                <button onclick="setCurrentView('custom-tasks')" class="px-4 py-2 rounded-lg flex items-center space-x-1 ${currentView === 'custom-tasks' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>משימות</span>
                </button>
            `;
            lucide.createIcons();
        }

        function renderHomeView() {
            const todayHebrew = getCurrentDay();
            const todayTasks = tasks[todayHebrew] || {};
            const pendingShoppingItems = shoppingList.filter(item => !item.completed).length;

            return `
                <div class="space-y-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-xl font-bold text-blue-800">
                                    יום ${todayHebrew} - סידור #${currentArrangement + 1}
                                </h2>
                                <div class="mt-2 text-sm text-blue-700">
                                    ${Object.entries(taskArrangements[currentArrangement]).map(([child, task]) => 
                                        `<span class="inline-block ml-4">${child}: ${task}</span>`
                                    ).join('')}
                                </div>
                            </div>
                            <button onclick="changeArrangement()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                סידור הבא
                            </button>
                        </div>
                    </div>

                    ${pendingShoppingItems > 0 ? `
                        <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i data-lucide="shopping-cart" class="w-5 h-5 text-orange-600 ml-2"></i>
                                <span class="font-medium text-orange-800">
                                    יש ${pendingShoppingItems} פריטים ברשימת הקניות
                                </span>
                            </div>
                        </div>
                    ` : ''}

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">משימות היום - ${todayHebrew}</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${Object.entries(todayTasks).map(([task, taskInfo]) => `
                                <div class="p-4 rounded-lg border-2 ${taskInfo.completed ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <button onclick="toggleTaskComplete('${todayHebrew}', '${task.replace(/'/g, "\\'")}')">
                                                <i data-lucide="${taskInfo.completed ? 'check-circle' : 'circle'}" class="w-6 h-6 ${taskInfo.completed ? 'text-green-600' : 'text-gray-400 hover:text-green-500'}"></i>
                                            </button>
                                            <div>
                                                <div class="font-medium ${taskInfo.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${task}</div>
                                                <div class="text-sm text-blue-600">${taskInfo.assignedTo}</div>
                                            </div>
                                        </div>
                                        <div class="px-2 py-1 rounded text-xs ${taskInfo.completed ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                            ${taskInfo.completed ? 'בוצע ✓' : 'ממתין'}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">משימות מותאמות</h3>
                            <button onclick="setCurrentView('custom-tasks')" class="px-3 py-1 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 text-sm">
                                ניהול מלא
                            </button>
                        </div>

                        <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
                                <input type="text" placeholder="משימה חדשה..." class="p-2 border rounded-lg text-sm" id="quick-task-input">
                                <select class="p-2 border rounded-lg text-sm" id="quick-task-assignee">
                                    <option value="">למי?</option>
                                    ${familyMembers.map(member => `<option value="${member}">${member}</option>`).join('')}
                                </select>
                                <input type="date" class="p-2 border rounded-lg text-sm" id="quick-task-target" title="תאריך יעד (אופציונלי)">
                                <button onclick="addQuickTask()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 text-sm">
                                    הוסף
                                </button>
                            </div>
                        </div>

                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${customTasks.filter(task => !task.completed).slice(0, 5).map(task => `
                                <div class="p-3 rounded-lg border ${getTaskColor(task)}">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <button onclick="toggleCustomTask(${task.id})">
                                                <i data-lucide="circle" class="w-5 h-5 text-gray-400 hover:text-green-500"></i>
                                            </button>
                                            <div>
                                                <div class="font-medium text-sm">${task.title}</div>
                                                <div class="text-xs text-gray-600">
                                                    ${task.assignedTo}
                                                    ${task.targetDate ? `• יעד: ${formatDate(task.targetDate)}` : ''}
                                                </div>
                                            </div>
                                        </div>
                                        <span class="text-xs px-2 py-1 rounded">
                                            ${getTaskLabel(task)}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                            
                            ${customTasks.filter(task => !task.completed).length === 0 ? 
                                '<div class="text-center text-gray-500 py-4 text-sm">אין משימות מותאמות</div>' : ''
                            }
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">רשימת קניות</h3>
                            <button onclick="setCurrentView('shopping')" class="px-3 py-1 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm">
                                עריכה מלאה
                            </button>
                        </div>
                        
                        <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                            <div class="flex gap-2">
                                <input type="text" placeholder="הוסף פריט..." class="flex-1 p-2 border rounded-lg text-sm" id="quick-shopping-input" onkeypress="if(event.key==='Enter') addQuickShoppingItem()">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-bold text-red-600 mb-3">
                                    לקנות (${shoppingList.filter(item => !item.completed).length})
                                </h4>
                                <div class="space-y-2 max-h-32 overflow-y-auto">
                                    ${shoppingList.filter(item => !item.completed).slice(0, 5).map(item => `
                                        <div class="flex items-center justify-between p-2 bg-red-50 rounded">
                                            <div class="flex items-center space-x-2">
                                                <button onclick="toggleShoppingItem(${item.id})">
                                                    <i data-lucide="circle" class="w-4 h-4 text-red-500"></i>
                                                </button>
                                                <div class="text-sm">${item.item}</div>
                                            </div>
                                            <button onclick="removeShoppingItem(${item.id})">
                                                <i data-lucide="trash-2" class="w-3 h-3 text-red-500"></i>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div>
                                <h4 class="font-bold text-green-600 mb-3">
                                    נקנו (${shoppingList.filter(item => item.completed).length})
                                </h4>
                                <div class="space-y-2 max-h-32 overflow-y-auto">
                                    ${shoppingList.filter(item => item.completed).slice(0, 5).map(item => `
                                        <div class="flex items-center justify-between p-2 bg-green-50 rounded">
                                            <div class="flex items-center space-x-2">
                                                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                                                <div class="text-sm line-through text-gray-500">${item.item}</div>
                                            </div>
                                            <button onclick="removeShoppingItem(${item.id})">
                                                <i data-lucide="trash-2" class="w-3 h-3 text-red-500"></i>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCalendarView() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">לוז משפחתי</h2>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">הוספת אירוע</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" placeholder="פעילות" class="p-3 border rounded-lg" id="new-event-activity">
                            <select class="p-3 border rounded-lg" id="new-event-member">
                                <option value="">בחר בן משפחה</option>
                                ${familyMembers.map(member => `<option value="${member}">${member}</option>`).join('')}
                            </select>
                            <input type="date" class="p-3 border rounded-lg" id="new-event-date">
                            <input type="time" class="p-3 border rounded-lg" id="new-event-time">
                        </div>
                        
                        <div class="mb-4">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="new-event-transport" class="w-4 h-4">
                                <span>נדרשת הסעה</span>
                            </label>
                        </div>
                        
                        <button onclick="addNewCalendarEvent()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            הוסף אירוע
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">אירועים קרובים</h3>
                        
                        <div class="space-y-3">
                            ${calendar
                                .sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time))
                                .slice(0, 10)
                                .map(event => `
                                <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-medium">${event.activity}</div>
                                            <div class="text-sm text-gray-600">
                                                ${event.member} • ${formatDate(event.date)} • ${event.time}
                                                ${event.transport ? '<span class="text-orange-600"> • נדרשת הסעה</span>' : ''}
                                            </div>
                                        </div>
                                        <button onclick="removeCalendarEvent(${event.id})" class="text-red-500 hover:text-red-700">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                            
                            ${calendar.length === 0 ? 
                                '<div class="text-center text-gray-500 py-8">אין אירועים מתוכננים</div>' : ''
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        function renderShoppingView() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">רשימת קניות</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" placeholder="מה לקנות?" class="p-3 border rounded-lg" id="new-item">
                            <select class="p-3 border rounded-lg" id="new-item-by">
                                <option value="">מי מבקש?</option>
                                ${familyMembers.map(member => `<option value="${member}">${member}</option>`).join('')}
                            </select>
                        </div>
                        <button onclick="addNewShoppingItem()" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600">
                            הוסף לרשימה
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-lg font-bold text-red-600 mb-4">
                                לקנות (${shoppingList.filter(item => !item.completed).length})
                            </h3>
                            <div class="space-y-2">
                                ${shoppingList.filter(item => !item.completed).map(item => `
                                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                        <div class="flex items-center space-x-2">
                                            <button onclick="toggleShoppingItem(${item.id})">
                                                <i data-lucide="circle" class="w-5 h-5 text-red-500"></i>
                                            </button>
                                            <div>
                                                <div class="font-medium">${item.item}</div>
                                                <div class="text-sm text-gray-600">${item.addedBy}</div>
                                            </div>
                                        </div>
                                        <button onclick="removeShoppingItem(${item.id})">
                                            <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-lg font-bold text-green-600 mb-4">
                                נקנו (${shoppingList.filter(item => item.completed).length})
                            </h3>
                            <div class="space-y-2">
                                ${shoppingList.filter(item => item.completed).map(item => `
                                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                        <div class="flex items-center space-x-2">
                                            <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                                            <div>
                                                <div class="font-medium line-through text-gray-500">${item.item}</div>
                                                <div class="text-sm text-gray-500">${item.addedBy}</div>
                                            </div>
                                        </div>
                                        <button onclick="removeShoppingItem(${item.id})">
                                            <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCustomTasksView() {
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">משימות מותאמות</h2>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input type="text" placeholder="כותרת המשימה" class="p-3 border rounded-lg" id="new-task-title">
                            <select class="p-3 border rounded-lg" id="new-task-assignee">
                                <option value="">למי להקצות?</option>
                                ${familyMembers.map(member => `<option value="${member}">${member}</option>`).join('')}
                            </select>
                            <input type="date" class="p-3 border rounded-lg" id="new-task-target-full" title="תאריך יעד">
                        </div>
                        <button onclick="addNewCustomTask()" class="px-6 py-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">
                            הוסף משימה
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            משימות פעילות (${customTasks.filter(task => !task.completed).length})
                        </h3>
                        
                        <div class="space-y-3">
                            ${customTasks.filter(task => !task.completed).map(task => `
                                <div class="p-4 rounded-lg border ${getTaskColor(task)}">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <button onclick="toggleCustomTask(${task.id})">
                                                <i data-lucide="circle" class="w-6 h-6 text-gray-400 hover:text-green-500"></i>
                                            </button>
                                            <div>
                                                <div class="font-medium text-lg">${task.title}</div>
                                                <div class="text-sm text-gray-600">
                                                    אחראי: ${task.assignedTo}
                                                    ${task.targetDate ? `• יעד: ${formatDate(task.targetDate)}` : ''}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="flex items-center space-x-2">
                                            <span class="px-3 py-1 rounded text-sm font-medium">
                                                ${getTaskLabel(task)}
                                            </span>
                                            <button onclick="removeCustomTask(${task.id})">
                                                <i data-lucide="trash-2" class="w-5 h-5 text-red-500"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-green-600 mb-4">
                            משימות שבוצעו (${customTasks.filter(task => task.completed).length})
                        </h3>
                        
                        <div class="space-y-2">
                            ${customTasks.filter(task => task.completed).map(task => `
                                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                    <div class="flex items-center space-x-2">
                                        <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                                        <div>
                                            <div class="font-medium line-through text-gray-500">${task.title}</div>
                                            <div class="text-sm text-gray-500">${task.assignedTo}</div>
                                        </div>
                                    </div>
                                    <button onclick="removeCustomTask(${task.id})">
                                        <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCurrentView() {
            let content = '';
            switch (currentView) {
                case 'home':
                    content = renderHomeView();
                    break;
                case 'calendar':
                    content = renderCalendarView();
                    break;
                case 'shopping':
                    content = renderShoppingView();
                    break;
                case 'custom-tasks':
                    content = renderCustomTasksView();
                    break;
                default:
                    content = renderHomeView();
            }
            
            document.getElementById('main-content').innerHTML = content;
            lucide.createIcons();
        }

        function renderApp() {
            renderNavigation();
            renderCurrentView();
            
            // Hide loading and show app
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        }

        // Helper UI Functions
        function addQuickTask() {
            const input = document.getElementById('quick-task-input');
            const select = document.getElementById('quick-task-assignee');
            const target = document.getElementById('quick-task-target');
            
            if (input.value.trim() && select.value) {
                addCustomTask(input.value.trim(), select.value, target.value);
                input.value = '';
                select.value = '';
                target.value = '';
            }
        }

        function addQuickShoppingItem() {
            const input = document.getElementById('quick-shopping-input');
            if (input.value.trim()) {
                addShoppingItem(input.value.trim(), 'הוספה מהירה');
                input.value = '';
            }
        }

        function addNewCalendarEvent() {
            const activity = document.getElementById('new-event-activity');
            const member = document.getElementById('new-event-member');
            const date = document.getElementById('new-event-date');
            const time = document.getElementById('new-event-time');
            const transport = document.getElementById('new-event-transport');
            
            if (activity.value && member.value && date.value && time.value) {
                addCalendarEvent(activity.value, member.value, date.value, time.value, transport.checked);
                activity.value = '';
                member.value = '';
                date.value = '';
                time.value = '';
                transport.checked = false;
            }
        }

        function addNewShoppingItem() {
            const item = document.getElementById('new-item');
            const by = document.getElementById('new-item-by');
            
            if (item.value && by.value) {
                addShoppingItem(item.value, by.value);
                item.value = '';
                by.value = '';
            }
        }

        function addNewCustomTask() {
            const title = document.getElementById('new-task-title');
            const assignee = document.getElementById('new-task-assignee');
            const target = document.getElementById('new-task-target-full');
            
            if (title.value && assignee.value) {
                addCustomTask(title.value, assignee.value, target.value);
                title.value = '';
                assignee.value = '';
                target.value = '';
            }
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            // Start loading data
            loadData();
            
            // Listen for real-time updates
            db.collection('family').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "modified") {
                        loadData();
                    }
                });
            });
        });
    </script>
</body>
</html>