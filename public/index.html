<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××©×¤×—×ª ×¤×•×¤×§×•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { direction: rtl; }
        .week-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .day-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            border-right: 4px solid #4f46e5;
        }
        .transport-option-btn, .time-option-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background-color: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .transport-option-btn:hover, .time-option-btn:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .transport-option-btn.active, .time-option-btn.active {
            border-color: #3b82f6;
            background-color: #3b82f6;
            color: white;
        }
        .driver-option-btn {
            padding: 6px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background-color: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        .driver-option-btn:hover {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }
        .driver-option-btn.active {
            border-color: #f59e0b;
            background-color: #f59e0b;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .recurring-option-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background-color: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        .recurring-option-btn:hover {
            border-color: #059669;
            background-color: #ecfdf5;
        }
        .recurring-option-btn.active {
            border-color: #059669;
            background-color: #059669;
            color: white;
        }
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background-color: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .filter-btn:hover {
            border-color: #8b5cf6;
            background-color: #f3f4f6;
        }
        .filter-btn.active {
            border-color: #8b5cf6;
            background-color: #8b5cf6;
            color: white;
        }
        .transport-time-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
        }
        .calendar-event {
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .calendar-event:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .event-actions {
            position: absolute;
            top: 2px;
            left: 2px;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            gap: 2px;
        }
        .calendar-event:hover .event-actions {
            opacity: 1;
        }
        .action-btn {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        .edit-btn {
            background: #3b82f6;
            color: white;
        }
        .delete-btn {
            background: #ef4444;
            color: white;
        }
        .custom-task-item {
            background: #fef3c7;
            border: 1px solid #f59e0b;
        }
        .weekly-task-item {
            background: #f3f4f6;
            border: 1px solid #6b7280;
        }
        .calendar-event-item {
            background: #ddd6fe;
            border: 1px solid #7c3aed;
        }
        .day-events-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1500;
        }
        .day-events-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .day-events-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        @media (max-width: 768px) {
            .week-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .modal-content {
                width: 95%;
                max-width: none;
                margin: 10px;
                max-height: 95vh;
            }
            
            .day-events-content {
                width: 95%;
                max-width: none;
                margin: 10px;
                padding: 16px;
                max-height: 90vh;
            }
            
            /* Mobile touch targets */
            button, .calendar-event, [onclick] {
                min-height: 44px;
            }
            
            /* Mobile form elements */
            input, select, textarea {
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            /* Mobile calendar */
            .calendar-day {
                min-height: 80px;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loading" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-lg font-bold text-gray-700">×˜×•×¢×Ÿ...</p>
        </div>
    </div>

    <!-- Authentication Screen -->
    <div id="auth-screen" class="fixed inset-0 bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center z-40 px-4 py-8" style="display: none;">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-2xl max-w-sm w-full">
            <div class="text-center mb-6">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">××©×¤×—×ª ×¤×•×¤×§×•</h1>
                <p class="text-sm sm:text-base text-gray-600">×›× ×™×¡×” ×œ××¤×œ×™×§×¦×™×” ×”××©×¤×—×ª×™×ª</p>
            </div>
            
            <div id="auth-content">
                <button id="google-signin-btn" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 flex items-center justify-center hover:bg-gray-50 transition-colors text-sm sm:text-base touch-manipulation">
                    <svg class="w-5 h-5 mr-2 flex-shrink-0" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span id="signin-text">×”×™×›× ×¡ ×¢× Google</span>
                </button>
                
                <div class="mt-4 text-center">
                    <p class="text-xs sm:text-sm text-gray-500">×¨×§ ××©×ª××©×™× ××•×¨×©×™× ×™×›×•×œ×™× ×œ×”×™×›× ×¡ ×œ××¤×œ×™×§×¦×™×”</p>
                    <p class="text-xs text-gray-400 mt-1" id="ios-hint" style="display: none;">×¢×œ iOS, ×™×™×ª×›×Ÿ ×©×ª×•×¢×‘×¨ ×œ×“×£ Google</p>
                    <div class="flex gap-2 justify-center mt-2">
                        <button onclick="showDebugInfo()" class="text-xs text-gray-400 hover:text-gray-600" style="background: none; border: none; text-decoration: underline;">
                            Debug Info
                        </button>
                        <button onclick="testBasicAuth()" class="text-xs text-blue-400 hover:text-blue-600" style="background: none; border: none; text-decoration: underline;">
                            Test Auth
                        </button>
                        <button onclick="startLiveDebug()" class="text-xs text-green-400 hover:text-green-600" style="background: none; border: none; text-decoration: underline;">
                            Live Debug
                        </button>
                    </div>
                    <div id="debug-output" class="mt-2 p-2 bg-gray-50 rounded text-xs text-left" style="display: none; font-family: monospace;"></div>
                </div>
            </div>
            
            <div id="auth-error" class="mt-4 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-xs sm:text-sm" style="display: none;"></div>
        </div>
    </div>

    <!-- Modal for editing events -->
    <div id="edit-event-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">×¢×¨×™×›×ª ××™×¨×•×¢</h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="text" placeholder="×¤×¢×™×œ×•×ª" class="p-3 border rounded-lg text-base" id="edit-event-activity">
                    <input type="date" class="p-3 border rounded-lg text-base" id="edit-event-date">
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="time" class="p-3 border rounded-lg text-base" id="edit-event-time" title="×©×¢×ª ×”××™×¨×•×¢">
                    <div></div>
                </div>
                
                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">××©×ª×ª×¤×™× (×‘×—×™×¨×” ××¨×•×‘×”)</h4>
                    <div id="edit-member-options" class="flex items-center gap-2 flex-wrap">
                        <button type="button" class="transport-option-btn" data-value="×˜×œ×™×”" onclick="toggleMember(this, 'edit')">×˜×œ×™×”</button>
                        <button type="button" class="transport-option-btn" data-value="×©×‘×™×˜" onclick="toggleMember(this, 'edit')">×©×‘×™×˜</button>
                        <button type="button" class="transport-option-btn" data-value="×©×’×™×" onclick="toggleMember(this, 'edit')">×©×’×™×</button>
                        <button type="button" class="transport-option-btn" data-value="××‘×™×ª×¨" onclick="toggleMember(this, 'edit')">××‘×™×ª×¨</button>
                        <button type="button" class="transport-option-btn" data-value="×œ×‘×™×" onclick="toggleMember(this, 'edit')">×œ×‘×™×</button>
                    </div>
                </div>
                
                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">×¡×•×’ ×”×¡×¢×” (×‘×—×™×¨×” ××¨×•×‘×”)</h4>
                    <div id="edit-transport-options" class="flex items-center gap-3 mb-3">
                        <button type="button" class="transport-option-btn" data-value="×”×œ×•×š" onclick="toggleTransport(this, 'edit')">×”×œ×•×š</button>
                        <button type="button" class="transport-option-btn" data-value="×—×–×•×¨" onclick="toggleTransport(this, 'edit')">×—×–×•×¨</button>
                        <button type="button" class="transport-option-btn" data-value="×œ×¨×›×‘×ª" onclick="toggleTransport(this, 'edit')">×œ×¨×›×‘×ª</button>
                    </div>
                    
                    <div id="edit-transport-times" class="space-y-3"></div>
                </div>

                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">××™×¨×•×¢ ×—×•×–×¨</h4>
                    <div id="edit-recurring-options" class="flex items-center gap-2 flex-wrap">
                        <button type="button" class="recurring-option-btn" data-value="none" onclick="toggleRecurring(this, 'edit')">×œ×œ× ×—×–×¨×”</button>
                        <button type="button" class="recurring-option-btn" data-value="daily" onclick="toggleRecurring(this, 'edit')">×™×•××™</button>
                        <button type="button" class="recurring-option-btn" data-value="weekly" onclick="toggleRecurring(this, 'edit')">×©×‘×•×¢×™</button>
                        <button type="button" class="recurring-option-btn" data-value="monthly" onclick="toggleRecurring(this, 'edit')">×—×•×“×©×™</button>
                    </div>
                </div>
                
                <div class="flex gap-2 pt-4">
                    <button onclick="saveEditedEvent()" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        ×©××•×¨ ×©×™× ×•×™×™×
                    </button>
                    <button onclick="deleteFromEdit()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        ××—×§
                    </button>
                    <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        ×‘×™×˜×•×œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete confirmation modal -->
    <div id="delete-event-modal" class="modal">
        <div class="modal-content max-w-md">
            <div class="text-center">
                <div class="mb-4">
                    <div class="mx-auto w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-3">
                        <i data-lucide="trash-2" class="w-6 h-6 text-red-600"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">××—×™×§×ª ××™×¨×•×¢</h3>
                </div>
                
                <div id="event-delete-details" class="bg-gray-50 p-3 rounded-lg mb-4 text-sm text-gray-700"></div>
                
                <div id="recurring-delete-options" class="space-y-3 mb-6" style="display: none;">
                    <p class="text-sm text-gray-600 mb-4">×–×”×• ××™×¨×•×¢ ×—×•×–×¨. ×× × ×‘×—×¨ ××” ×œ××—×•×§:</p>
                    <div class="space-y-3">
                        <button onclick="deleteEvent('single')" class="w-full px-4 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 flex items-center justify-center">
                            <i data-lucide="calendar-x" class="w-4 h-4 mr-2"></i>
                            ××—×§ ×¨×§ ××ª ×”××™×¨×•×¢ ×”×–×”
                        </button>
                        <button onclick="deleteEvent('all')" class="w-full px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 flex items-center justify-center">
                            <i data-lucide="calendar-off" class="w-4 h-4 mr-2"></i>
                            ××—×§ ××ª ×›×œ ×”×¡×“×¨×”
                        </button>
                        <button onclick="closeDeleteModal()" class="w-full px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            ×‘×™×˜×•×œ
                        </button>
                    </div>
                </div>
                
                <div id="single-delete-options" class="space-y-3">
                    <p class="text-gray-600 mb-4">×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××™×¨×•×¢?</p>
                    <div class="flex gap-3 justify-center">
                        <button onclick="deleteEvent('single')" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 flex items-center">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-1"></i>
                            ××—×§
                        </button>
                        <button onclick="closeDeleteModal()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            ×‘×™×˜×•×œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Day events modal -->
    <div id="day-events-modal" class="day-events-modal">
        <div class="day-events-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="day-events-title">××™×¨×•×¢×™ ×”×™×•×</h3>
                <button onclick="closeDayEventsModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="day-events-content" class="space-y-3"></div>
        </div>
    </div>

    <div id="app" style="display: none;">
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-2 sm:px-4">
                <div class="flex justify-between items-center h-14 sm:h-16">
                    <h1 class="text-base sm:text-xl font-bold text-gray-800 truncate">
                        <span class="hidden sm:inline">× ×™×”×•×œ ××©×¤×—×ª×™ - </span>××©×¤×—×ª ×¤×•×¤×§×•
                    </h1>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div class="hidden sm:flex space-x-2" id="nav-buttons"></div>
                        <div class="flex items-center space-x-1 sm:space-x-2 border-r border-gray-300 pr-2 sm:pr-4">
                            <button id="notification-btn" onclick="toggleNotifications()" class="px-2 py-1 rounded text-xs sm:text-sm touch-manipulation hidden" title="×”×•×“×¢×•×ª">
                                <i data-lucide="bell" class="w-4 h-4"></i>
                            </button>
                            <span id="user-email" class="text-xs sm:text-sm text-gray-600 max-w-20 sm:max-w-none truncate"></span>
                            <button onclick="signOut()" class="px-2 sm:px-3 py-1 bg-red-500 text-white rounded text-xs sm:text-sm hover:bg-red-600 touch-manipulation">
                                ×™×¦×™××”
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Mobile Navigation -->
                <div class="sm:hidden pb-2" id="mobile-nav-buttons"></div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-8" id="main-content"></main>
    </div>

    <script>
        // Global error handler for debugging
        window.onerror = function(msg, url, line, col, error) {
            console.error('Global error:', msg, 'at', line + ':' + col);
            const authError = document.getElementById('auth-error');
            if (authError) {
                authError.innerHTML = `JavaScript Error: ${msg}<br>Line: ${line}`;
                authError.style.display = 'block';
            }
        };

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDOQ29YJkEQqSk9j7FvNsZEwE-xuVh5kQU",
            authDomain: "family-popko.firebaseapp.com",
            databaseURL: "https://family-popko-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "family-popko",
            storageBucket: "family-popko.appspot.com",
            messagingSenderId: "902790940853",
            appId: "1:902790940853:web:23238a2f63612d3ac3d6fc"
        };

        let database;
        let auth;
        let currentUser = null;
        
        // Approved family email addresses
        const approvedEmails = [
            'shavitp@gmail.com',
            'taltola7777@gmail.com',
            'sagipopko@gmail.com',
            'evyatarpopko@gmail.com',
            'lavipopko@gmail.com'
        ];

        // Push Notification System
        let notificationPermission = 'default';
        let serviceWorkerRegistration = null;

        // Check if push notifications are supported
        function isPushSupported() {
            return 'serviceWorker' in navigator && 'PushManager' in window;
        }

        // Register service worker for push notifications
        async function registerServiceWorker() {
            if (!isPushSupported()) {
                console.log('Push notifications are not supported');
                return false;
            }

            try {
                // Register service worker inline
                const swCode = `
                    self.addEventListener('push', function(event) {
                        const options = {
                            body: event.data ? event.data.text() : '××©×¤×—×ª ×¤×•×¤×§×• - ×¢×“×›×•×Ÿ ×—×“×©',
                            icon: '/icon-192x192.png',
                            badge: '/badge-72x72.png',
                            vibrate: [200, 100, 200],
                            dir: 'rtl',
                            lang: 'he',
                            tag: 'popko-family',
                            requireInteraction: true,
                            actions: [
                                {
                                    action: 'open',
                                    title: '×¤×ª×— ××¤×œ×™×§×¦×™×”',
                                    icon: '/action-icon.png'
                                },
                                {
                                    action: 'close',
                                    title: '×¡×’×•×¨',
                                    icon: '/close-icon.png'
                                }
                            ]
                        };

                        event.waitUntil(
                            self.registration.showNotification('××©×¤×—×ª ×¤×•×¤×§×•', options)
                        );
                    });

                    self.addEventListener('notificationclick', function(event) {
                        event.notification.close();

                        if (event.action === 'open') {
                            event.waitUntil(
                                clients.openWindow('/')
                            );
                        }
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                serviceWorkerRegistration = await navigator.serviceWorker.register(swUrl);
                console.log('Service Worker registered successfully');
                return true;
            } catch (error) {
                console.error('Service Worker registration failed:', error);
                return false;
            }
        }

        // Request notification permission
        async function requestNotificationPermission() {
            if (!isPushSupported()) {
                return false;
            }

            try {
                const permission = await Notification.requestPermission();
                notificationPermission = permission;
                
                if (permission === 'granted') {
                    console.log('Notification permission granted');
                    await registerServiceWorker();
                    return true;
                } else {
                    console.log('Notification permission denied');
                    return false;
                }
            } catch (error) {
                console.error('Error requesting notification permission:', error);
                return false;
            }
        }

        // Send local notification
        function sendLocalNotification(title, body, options = {}) {
            if (!isPushSupported() || notificationPermission !== 'granted') {
                console.log('Notifications not available or not permitted');
                return;
            }

            const defaultOptions = {
                body: body,
                icon: '/icon-192x192.png',
                badge: '/badge-72x72.png',
                vibrate: [200, 100, 200],
                dir: 'rtl',
                lang: 'he',
                tag: 'popko-family',
                requireInteraction: true,
                ...options
            };

            try {
                if (serviceWorkerRegistration) {
                    serviceWorkerRegistration.showNotification(title, defaultOptions);
                } else {
                    new Notification(title, defaultOptions);
                }
            } catch (error) {
                console.error('Error sending notification:', error);
            }
        }

        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                auth = firebase.auth();
                
                // Configure auth for better iOS compatibility
                auth.useDeviceLanguage();
                
                // Set persistence for iOS Safari
                auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                    .then(() => {
                        console.log('Firebase auth persistence set to LOCAL');
                    })
                    .catch((error) => {
                        console.warn('Could not set auth persistence:', error);
                        // Fallback to session persistence
                        return auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
                    });

                console.log('Firebase initialized successfully');
            } else {
                throw new Error("Firebase library not loaded");
            }
        } catch (error) {
            console.error('Error initializing Firebase:', error);
            const loadingDiv = document.getElementById('loading');
            if (loadingDiv) {
                loadingDiv.innerHTML = `
                    <div class="text-center">
                        <div class="text-red-500 text-xl mb-4">âš ï¸ ×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×‘×¡×™×¡ ×”× ×ª×•× ×™×</div>
                        <p class="text-gray-600">×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ×‘×¡×™×¡ ×”× ×ª×•× ×™× ×©×œ Firebase</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded">× ×¡×” ×©×•×‘</button>
                    </div>
                `;
            }
        }

        // Authentication Functions
        function showAuthScreen() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
        }

        function showApp() {
            console.log('showApp() called');
            updateLiveDebug('showApp() - hiding auth, showing app');
            
            const loading = document.getElementById('loading');
            const authScreen = document.getElementById('auth-screen');
            const app = document.getElementById('app');
            
            console.log('Elements found:', {
                loading: !!loading,
                authScreen: !!authScreen,
                app: !!app
            });
            
            if (loading) {
                loading.style.display = 'none';
                console.log('Loading hidden');
            }
            
            if (authScreen) {
                authScreen.style.display = 'none';
                console.log('Auth screen hidden');
            }
            
            if (app) {
                app.style.display = 'block';
                console.log('App shown');
                updateLiveDebug('âœ“ App UI should now be visible');
            } else {
                console.error('App element not found!');
                updateLiveDebug('âœ— ERROR: App element not found!');
            }
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideAuthError() {
            document.getElementById('auth-error').style.display = 'none';
        }

        function isEmailApproved(email) {
            return approvedEmails.includes(email.toLowerCase());
        }

        async function signInWithGoogle() {
            try {
                console.log('=== SIGN IN ATTEMPT STARTED ===');
                updateLiveDebug('Sign in attempt started');
                hideAuthError();
                
                // Show loading state
                const signInText = document.getElementById('signin-text');
                if (signInText) {
                    signInText.textContent = '××ª×—×‘×¨...';
                }
                
                const provider = new firebase.auth.GoogleAuthProvider();
                console.log('Google provider created');
                
                // Try popup first (works on most devices)
                console.log('Attempting popup sign in...');
                const result = await auth.signInWithPopup(provider);
                
                console.log('Popup completed successfully!');
                console.log('Result:', result);
                console.log('User:', result.user);
                console.log('User email:', result.user ? result.user.email : 'NO USER');
                
                if (result && result.user) {
                    console.log('Calling handleSignInResult with user:', result.user.email);
                    updateLiveDebug('Popup successful, user: ' + result.user.email);
                    await handleSignInResult(result.user);
                } else {
                    console.error('No user in result!');
                    updateLiveDebug('ERROR: No user in popup result');
                    showAuthError('×œ× ×”×ª×§×‘×œ ××©×ª××© ×Google. ×× × × ×¡×” ×©×•×‘.');
                }
                
            } catch (error) {
                console.error('=== SIGN IN ERROR ===');
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Full error:', error);
                
                // Reset button text
                const signInText = document.getElementById('signin-text');
                if (signInText) {
                    signInText.textContent = '×”×™×›× ×¡ ×¢× Google';
                }
                
                // Try redirect as fallback for mobile
                if (error.code === 'auth/popup-blocked' || error.code === 'auth/cancelled-popup-request') {
                    console.log('Popup failed, trying redirect...');
                    try {
                        if (signInText) {
                            signInText.textContent = '××¢×‘×™×¨ ×œGoogle...';
                        }
                        await auth.signInWithRedirect(provider);
                        return;
                    } catch (redirectError) {
                        console.error('Redirect also failed:', redirectError);
                        showAuthError('×›× ×™×¡×” × ×›×©×œ×”. ×× × × ×¡×” ×©×•×‘ ××• × ×¡×” ×‘×“×¤×“×¤×Ÿ ××—×¨.');
                    }
                } else {
                    // Show specific error messages
                    if (error.code === 'auth/unauthorized-domain') {
                        showAuthError('Domain ×œ× ××•×¨×©×”. ×× × ×¦×•×¨ ×§×©×¨ ×¢× ×”××¤×ª×—.');
                    } else {
                        showAuthError('×©×’×™××” ×‘×›× ×™×¡×”: ' + (error.message || '×× × × ×¡×” ×©×•×‘'));
                    }
                }
            }
        }

        // Handle sign-in result (used for both popup and redirect)
        async function handleSignInResult(user) {
            console.log('=== HANDLE SIGN IN RESULT ===');
            console.log('User object:', user);
            console.log('User email:', user ? user.email : 'NO EMAIL');
            console.log('Approved emails list:', approvedEmails);
            
            if (user && user.email) {
                console.log('Checking if email is approved...');
                const isApproved = isEmailApproved(user.email);
                console.log('Email approved:', isApproved);
                
                if (isApproved) {
                    console.log('âœ“ User approved! Setting up app...');
                    updateLiveDebug('âœ“ User approved: ' + user.email);
                    currentUser = user;
                    
                    const emailElement = document.getElementById('user-email');
                    console.log('Email element found:', !!emailElement);
                    if (emailElement) {
                        emailElement.textContent = user.email;
                    }
                    
                    console.log('Calling showApp()...');
                    updateLiveDebug('Calling showApp()...');
                    showApp();
                    
                    console.log('Calling initializeApp()...');
                    updateLiveDebug('Calling initializeApp()...');
                    initializeApp();
                    
                    console.log('âœ“ Authentication complete!');
                    updateLiveDebug('âœ“ Authentication complete!');
                } else {
                    console.log('âœ— User email not approved:', user.email);
                    updateLiveDebug('âœ— Email not approved: ' + user.email);
                    console.log('Signing out...');
                    await auth.signOut();
                    showAuthError('×”×›× ×™×¡×” × ×“×—×ª×”. ×”××™×™×œ ' + user.email + ' ×œ× ×‘×¨×©×™××ª ×”××•×¨×©×™×.');
                }
            } else {
                console.log('âœ— No user or no email');
                showAuthError('×©×’×™××”: ×œ× ×”×ª×§×‘×œ×• ×¤×¨×˜×™ ××©×ª××© ×Google.');
            }
            console.log('=== END HANDLE SIGN IN RESULT ===');
        }

        // Debug function for testing
        function showDebugInfo() {
            try {
                const debugOutput = document.getElementById('debug-output');
                if (!debugOutput) {
                    alert('Debug output element not found');
                    return;
                }

                let debugText = '=== DEBUG INFO ===\n';
                debugText += `Time: ${new Date().toLocaleString()}\n`;
                debugText += `User Agent: ${navigator.userAgent.substring(0, 100)}...\n`;
                debugText += `URL: ${window.location.href}\n`;
                
                // Check Firebase
                if (typeof firebase === 'undefined') {
                    debugText += 'ERROR: Firebase not loaded\n';
                } else {
                    debugText += 'Firebase: Loaded âœ“\n';
                }

                // Check Auth
                if (typeof auth === 'undefined' || !auth) {
                    debugText += 'ERROR: Auth not initialized\n';
                } else {
                    debugText += 'Auth: Initialized âœ“\n';
                    debugText += `Current user: ${auth.currentUser ? auth.currentUser.email : 'null'}\n`;
                }

                // Check approved emails
                debugText += `Approved emails: ${approvedEmails.join(', ')}\n`;
                
                // Check current state
                if (auth && auth.currentUser) {
                    debugText += `User email: ${auth.currentUser.email}\n`;
                    debugText += `Is approved: ${isEmailApproved(auth.currentUser.email)}\n`;
                }

                // Show in UI
                debugOutput.textContent = debugText;
                debugOutput.style.display = 'block';

                // Also log to console
                console.log(debugText);
                
            } catch (error) {
                alert('Debug error: ' + error.message);
                console.error('Debug error:', error);
            }
        }

        // Test basic auth functionality
        function testBasicAuth() {
            try {
                const debugOutput = document.getElementById('debug-output');
                if (!debugOutput) {
                    alert('Debug output not found');
                    return;
                }

                let testText = '=== AUTH TEST ===\n';
                testText += 'Starting basic auth test...\n';

                // Test Firebase
                if (typeof firebase === 'undefined') {
                    testText += 'ERROR: Firebase not loaded!\n';
                    debugOutput.textContent = testText;
                    debugOutput.style.display = 'block';
                    return;
                }
                testText += 'Firebase: OK\n';

                // Test Auth
                if (!auth) {
                    testText += 'ERROR: Auth not initialized!\n';
                    debugOutput.textContent = testText;
                    debugOutput.style.display = 'block';
                    return;
                }
                testText += 'Auth: OK\n';

                // Test provider creation
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    testText += 'Google Provider: OK\n';
                } catch (providerError) {
                    testText += 'Google Provider ERROR: ' + providerError.message + '\n';
                }

                // Test button functionality
                const signInBtn = document.getElementById('google-signin-btn');
                if (signInBtn) {
                    testText += 'Sign-in button: Found\n';
                } else {
                    testText += 'Sign-in button: NOT FOUND\n';
                }

                testText += '\nTest complete. If all OK, try signing in.\n';
                
                debugOutput.textContent = testText;
                debugOutput.style.display = 'block';
                console.log(testText);

            } catch (error) {
                const msg = 'Test error: ' + error.message;
                alert(msg);
                console.error(msg, error);
            }
        }

        // Live debugging
        let liveDebugActive = false;
        function startLiveDebug() {
            liveDebugActive = !liveDebugActive;
            const debugOutput = document.getElementById('debug-output');
            
            if (liveDebugActive) {
                debugOutput.style.display = 'block';
                debugOutput.textContent = '=== LIVE DEBUG ACTIVE ===\nWaiting for events...\n';
                console.log('Live debug started');
            } else {
                debugOutput.style.display = 'none';
                console.log('Live debug stopped');
            }
        }

        function updateLiveDebug(message) {
            if (liveDebugActive) {
                const debugOutput = document.getElementById('debug-output');
                if (debugOutput) {
                    const timestamp = new Date().toLocaleTimeString();
                    debugOutput.textContent += `[${timestamp}] ${message}\n`;
                    debugOutput.scrollTop = debugOutput.scrollHeight;
                }
            }
        }

        // Make functions available globally
        window.debugAuth = showDebugInfo;
        window.showDebugInfo = showDebugInfo;
        window.testBasicAuth = testBasicAuth;
        window.startLiveDebug = startLiveDebug;

        async function signOut() {
            try {
                await auth.signOut();
                currentUser = null;
                showAuthScreen();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Notification management functions
        async function toggleNotifications() {
            if (notificationPermission === 'granted') {
                // Show notification settings or send test notification
                sendLocalNotification('××©×¤×—×ª ×¤×•×¤×§×•', '×”×ª×¨××•×ª ×¤×¢×™×œ×•×ª! ğŸ””');
            } else if (notificationPermission === 'default') {
                const granted = await requestNotificationPermission();
                if (granted) {
                    sendLocalNotification('××©×¤×—×ª ×¤×•×¤×§×•', '×”×ª×¨××•×ª ×”×•×¤×¢×œ×• ×‘×”×¦×œ×—×”! ğŸ‰');
                    updateNotificationButton();
                }
            } else {
                alert('×”×ª×¨××•×ª × ×—×¡××• ×‘×“×¤×“×¤×Ÿ. ×× × ××¤×©×¨ ×”×ª×¨××•×ª ×‘×”×’×“×¨×•×ª ×”×“×¤×“×¤×Ÿ.');
            }
        }

        function updateNotificationButton() {
            const btn = document.getElementById('notification-btn');
            if (!btn) return;

            if (notificationPermission === 'granted') {
                btn.className = 'px-2 py-1 bg-green-100 text-green-700 rounded text-xs sm:text-sm touch-manipulation';
                btn.title = '×”×ª×¨××•×ª ×¤×¢×™×œ×•×ª - ×œ×—×¥ ×œ×‘×“×™×§×”';
            } else if (notificationPermission === 'default') {
                btn.className = 'px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs sm:text-sm touch-manipulation';
                btn.title = '×œ×—×¥ ×œ×”×¤×¢×œ×ª ×”×ª×¨××•×ª';
            } else {
                btn.className = 'px-2 py-1 bg-red-100 text-red-700 rounded text-xs sm:text-sm touch-manipulation';
                btn.title = '×”×ª×¨××•×ª ×—×¡×•××•×ª';
            }
        }

        function initializeNotifications() {
            if (isPushSupported()) {
                // Check current permission
                notificationPermission = Notification.permission;
                
                // Show notification button
                const btn = document.getElementById('notification-btn');
                if (btn) {
                    btn.classList.remove('hidden');
                    updateNotificationButton();
                }

                // Auto-request permission if default (optional)
                if (notificationPermission === 'default') {
                    setTimeout(() => {
                        requestNotificationPermission().then(granted => {
                            if (granted) updateNotificationButton();
                        });
                    }, 2000); // Wait 2 seconds after app loads
                } else if (notificationPermission === 'granted') {
                    registerServiceWorker();
                }
            }
        }

        // Monitor authentication state
        function setupAuthStateListener() {
            console.log('Setting up simplified auth state listener...');
            
            // Check for redirect result first
            auth.getRedirectResult()
                .then((result) => {
                    console.log('Redirect result check:', result);
                    if (result && result.user) {
                        console.log('Redirect sign-in successful:', result.user.email);
                        handleSignInResult(result.user);
                    }
                })
                .catch((error) => {
                    console.error('Redirect result error:', error);
                    showAuthError('×©×’×™××” ×‘×—×–×¨×” ×Google: ' + error.message);
                });

            // Simple auth state monitoring
            auth.onAuthStateChanged((user) => {
                console.log('=== AUTH STATE CHANGED ===');
                console.log('User:', user ? user.email : 'no user');
                console.log('Current user variable:', currentUser ? currentUser.email : 'no current user');
                
                if (user) {
                    console.log('Auth state: User signed in, checking approval...');
                    if (isEmailApproved(user.email)) {
                        console.log('Auth state: User approved, showing app');
                        currentUser = user;
                        const emailElement = document.getElementById('user-email');
                        if (emailElement) {
                            emailElement.textContent = user.email;
                        }
                        hideAuthError();
                        showApp();
                        initializeApp();
                    } else {
                        console.log('Auth state: User not approved, signing out');
                        auth.signOut();
                        showAuthError('×”×›× ×™×¡×” × ×“×—×ª×”. ×”××™×™×œ ' + user.email + ' ×œ× ××•×¨×©×”.');
                        showAuthScreen();
                    }
                } else {
                    console.log('Auth state: No user, showing auth screen');
                    currentUser = null;
                    showAuthScreen();
                }
                console.log('=== END AUTH STATE CHANGED ===');
            });
        }

        // Global Variables
        let currentView = 'home';
        let currentArrangement = 0;
        let calendar = [];
        let shoppingList = [];
        let customTasks = [];
        let weeklyTasks = {};
        let isInitialLoad = true;
        let editingEventId = null;
        let deletingEventId = null;
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();
        let selectedMemberFilter = null;
        let lastArrangementUpdate = null;

        const familyMembers = ['×˜×œ×™×”', '×©×‘×™×˜', '×©×’×™×', '××‘×™×ª×¨', '×œ×‘×™×'];
        const drivers = ['×©×‘×™×˜', '×˜×œ×™×”'];
        const daysOfWeekHebrew = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
        
        // Task arrangements
        const taskArrangements = [
            { '×©×’×™×': '×¤×—', '××‘×™×ª×¨': '××“×™×—', '×œ×‘×™×': '××—×–×•×¨' },
            { '×©×’×™×': '××“×™×—', '××‘×™×ª×¨': '××—×–×•×¨', '×œ×‘×™×': '×¤×—' },
            { '×©×’×™×': '××—×–×•×¨', '××‘×™×ª×¨': '×¤×—', '×œ×‘×™×': '××“×™×—' }
        ];

        // Dog walking schedule
        const dogWalkingSchedule = {
            '×¨××©×•×Ÿ': '×œ×‘×™×',
            '×©× ×™': '××‘×™×ª×¨',
            '×©×œ×™×©×™': '×©×’×™×',
            '×¨×‘×™×¢×™': '××‘×™×ª×¨',
            '×—××™×©×™': '×©×’×™×',
            '×©×™×©×™': '×œ×‘×™× ×•××‘×™×ª×¨',
            '×©×‘×ª': '×©×’×™×'
        };

        // Member colors
        const memberColors = {
            '×©×’×™×': 'bg-red-100 border-red-300 text-red-800',
            '××‘×™×ª×¨': 'bg-blue-100 border-blue-300 text-blue-800',
            '×œ×‘×™×': 'bg-green-100 border-green-300 text-green-800',
            '×˜×œ×™×”': 'bg-purple-100 border-purple-300 text-purple-800',
            '×©×‘×™×˜': 'bg-orange-100 border-orange-300 text-orange-800'
        };

        // Helper Functions
        function formatDate(date) {
            if (typeof date === 'string') {
                const d = new Date(date + 'T00:00:00');
                return d.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });
            }
            return new Date(date).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });
        }

        function formatTime(time) {
            if (!time) return '';
            return time;
        }

        function getDateString(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function isSameDate(date1, date2) {
            return getDateString(date1) === getDateString(date2);
        }

        function getWeekStartDate(weekOffset = 0) {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysToSunday = dayOfWeek === 0 ? 0 : -dayOfWeek;
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() + daysToSunday + (weekOffset * 7));
            weekStart.setHours(0, 0, 0, 0);
            return weekStart;
        }

        function getWeekKey(weekOffset = 0) {
            const weekStart = getWeekStartDate(weekOffset);
            return `week_${weekStart.getFullYear()}_${weekStart.getMonth() + 1}_${weekStart.getDate()}`;
        }

        function getDayOfWeekFromDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return daysOfWeekHebrew[date.getDay()];
        }

        function initializeWeeklyTasks() {
            const daysOfWeek = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
            let hasChanges = false;
            
            for (let weekOffset = 0; weekOffset < 2; weekOffset++) {
                const weekKey = getWeekKey(weekOffset);
                
                if (!weeklyTasks[weekKey]) {
                    weeklyTasks[weekKey] = {};
                    hasChanges = true;
                    
                    daysOfWeek.forEach(day => {
                        weeklyTasks[weekKey][day] = {};
                        
                        // Add dog walking
                        weeklyTasks[weekKey][day]['×˜×™×•×œ ×¢× ×‘××‘×”'] = {
                            assignedTo: dogWalkingSchedule[day],
                            completed: false
                        };
                        
                        // Add chores based on current arrangement
                        const arrangement = taskArrangements[currentArrangement];
                        Object.entries(arrangement).forEach(([child, task]) => {
                            weeklyTasks[weekKey][day][task] = { 
                                assignedTo: child, 
                                completed: false 
                            };
                        });
                    });
                }
            }
            
            if (hasChanges) {
                saveData('weeklyTasks', weeklyTasks);
            }
        }

        // Filter functions
        function setMemberFilter(member) {
            selectedMemberFilter = selectedMemberFilter === member ? null : member;
            updateFilterButtons();
            renderCurrentView();
        }

        function updateFilterButtons() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                const member = btn.dataset.member;
                if (member === selectedMemberFilter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function getFilteredTasks(tasks, dayTasks) {
            if (!selectedMemberFilter) return tasks;
            
            const filtered = {};
            Object.entries(tasks).forEach(([taskName, taskInfo]) => {
                if (taskInfo.assignedTo.includes(selectedMemberFilter)) {
                    filtered[taskName] = taskInfo;
                }
            });
            return filtered;
        }

        function getFilteredCalendarEvents() {
            if (!selectedMemberFilter) return calendar;
            
            return calendar.filter(event => {
                if (Array.isArray(event.members)) {
                    return event.members.includes(selectedMemberFilter);
                }
                return event.member === selectedMemberFilter;
            });
        }

        function getFilteredCustomTasks() {
            if (!selectedMemberFilter) return customTasks;
            
            return customTasks.filter(task => {
                return task.assignedTo === selectedMemberFilter;
            });
        }

        function getCustomTasksForDate(dateString) {
            return getFilteredCustomTasks().filter(task => {
                return task.targetDate === dateString;
            });
        }

        function getAllEventsForDate(dateString) {
            const events = getFilteredCalendarEvents().filter(event => event.date === dateString);
            const customTasks = getCustomTasksForDate(dateString);
            return { events, customTasks };
        }

        function openDayEventsModal(dateString, dayName) {
            const { events, customTasks } = getAllEventsForDate(dateString);
            const allItems = [...events, ...customTasks];
            
            if (allItems.length === 0) return;
            
            const title = `${dayName} - ${formatDate(dateString)}`;
            document.getElementById('day-events-title').textContent = title;
            
            let content = '';
            
            if (events.length > 0) {
                content += '<h4 class="font-bold text-gray-800 mb-2">××™×¨×•×¢×™ ×œ×•×— ×©× ×”:</h4>';
                content += '<div class="space-y-2 mb-4">';
                events.forEach(event => {
                    content += `
                        <div class="p-3 bg-indigo-50 border border-indigo-200 rounded">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-medium text-indigo-800">${event.activity}</div>
                                    ${event.time ? `<div class="text-sm text-indigo-600">â° ${formatTime(event.time)}</div>` : ''}
                                    ${event.transport ? `<div class="text-sm text-indigo-600">ğŸš— ${event.transport} ${event.transportTime ? `- ${formatTime(event.transportTime)}` : ''}</div>` : ''}
                                    <div class="text-sm text-gray-600">ğŸ‘¥ ${Array.isArray(event.members) ? event.members.join(', ') : event.member || ''}</div>
                                </div>
                                <button onclick="closeDayEventsModal(); openEditModal(${event.id})" 
                                        class="ml-2 px-2 py-1 bg-indigo-500 text-white rounded text-xs hover:bg-indigo-600 flex items-center">
                                    <i data-lucide="edit" class="w-3 h-3 ml-1"></i>
                                    ×¢×¨×•×š
                                </button>
                            </div>
                        </div>
                    `;
                });
                content += '</div>';
            }
            
            if (customTasks.length > 0) {
                content += '<h4 class="font-bold text-gray-800 mb-2">××©×™××•×ª ××•×ª×××•×ª ××™×©×™×ª:</h4>';
                content += '<div class="space-y-2">';
                customTasks.forEach(task => {
                    content += `
                        <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <button onclick="toggleCustomTask(${task.id}); setTimeout(() => { location.reload(); }, 500);">
                                        <i data-lucide="${task.completed ? 'check-circle' : 'circle'}" 
                                           class="w-5 h-5 ${task.completed ? 'text-green-600' : 'text-yellow-500'}"></i>
                                    </button>
                                    <div>
                                        <div class="font-medium ${task.completed ? 'line-through text-gray-500' : 'text-yellow-800'}">ğŸ“‹ ${task.title}</div>
                                        <div class="text-sm text-gray-600">××—×¨××™: ${task.assignedTo}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                content += '</div>';
            }
            
            document.getElementById('day-events-content').innerHTML = content;
            document.getElementById('day-events-modal').classList.add('show');
            lucide.createIcons();
        }

        function closeDayEventsModal() {
            document.getElementById('day-events-modal').classList.remove('show');
        }

        // Transport and Recurring functions
        function toggleTransport(selectedBtn, context = 'new') {
            const isAlreadyActive = selectedBtn.classList.contains('active');

            if (isAlreadyActive) {
                selectedBtn.classList.remove('active');
            } else {
                selectedBtn.classList.add('active');
            }
            
            updateTransportTimes(context);
        }

        function updateTransportTimes(context = 'new') {
            const transportContainerId = context === 'edit' ? 'edit-transport-options' : 'transport-options';
            const transportTimesId = context === 'edit' ? 'edit-transport-times' : 'transport-times';
            
            const selectedTransports = Array.from(document.querySelectorAll(`#${transportContainerId} .active`)).map(btn => btn.dataset.value);
            const transportTimesContainer = document.getElementById(transportTimesId);
            
            if (!transportTimesContainer) return;
            
            transportTimesContainer.innerHTML = '';
            
            selectedTransports.forEach(transport => {
                const timeContainer = document.createElement('div');
                timeContainer.className = 'transport-time-container';
                timeContainer.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-gray-700">${transport}</h5>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <input type="time" class="p-2 border rounded-lg text-base" 
                               placeholder="×©×¢×”" data-transport="${transport}" data-field="time">
                        <select class="p-2 border rounded-lg text-base" data-transport="${transport}" data-field="driver">
                            <option value="">×‘×—×¨ ××¡×™×¢</option>
                            ${drivers.map(driver => `<option value="${driver}">${driver}</option>`).join('')}
                        </select>
                    </div>
                `;
                transportTimesContainer.appendChild(timeContainer);
            });
        }

        function toggleMember(selectedBtn, context = 'new') {
            const isAlreadyActive = selectedBtn.classList.contains('active');

            if (isAlreadyActive) {
                selectedBtn.classList.remove('active');
            } else {
                selectedBtn.classList.add('active');
            }
        }

        function toggleRecurring(selectedBtn, context = 'new') {
            const containerId = context === 'edit' ? 'edit-recurring-options' : 'recurring-options';
            const optionsContainer = document.getElementById(containerId);

            optionsContainer.querySelectorAll('.recurring-option-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            selectedBtn.classList.add('active');
        }

        // Recurring event generation
        function generateRecurringEvents(baseEvent, recurringType, endDate = null) {
            const events = [];
            const baseDate = new Date(baseEvent.date + 'T00:00:00');
            const maxEvents = 52;
            let currentDate = new Date(baseDate);
            let count = 0;

            if (!endDate) {
                endDate = new Date();
                endDate.setFullYear(endDate.getFullYear() + 1);
            }

            while (currentDate <= endDate && count < maxEvents) {
                if (count > 0) {
                    const newEvent = {
                        ...baseEvent,
                        id: Date.now() + count,
                        date: getDateString(currentDate),
                        isRecurring: true,
                        originalEventId: baseEvent.id
                    };
                    events.push(newEvent);
                }

                switch (recurringType) {
                    case 'daily':
                        currentDate.setDate(currentDate.getDate() + 1);
                        break;
                    case 'weekly':
                        currentDate.setDate(currentDate.getDate() + 7);
                        break;
                    case 'monthly':
                        currentDate.setMonth(currentDate.getMonth() + 1);
                        break;
                }
                count++;
            }

            return events;
        }

        // Check and update arrangement if needed
        async function checkAndUpdateArrangement() {
            const now = new Date();
            const lastUpdate = lastArrangementUpdate ? new Date(lastArrangementUpdate) : null;
            
            // Check if it's past Saturday 23:59 since last update
            if (shouldUpdateArrangement(now, lastUpdate)) {
                console.log('Time to update arrangement automatically');
                currentArrangement = (currentArrangement + 1) % 3;
                lastArrangementUpdate = now.toISOString();
                
                // Save to Firebase
                await saveData('arrangement', currentArrangement);
                await saveData('lastArrangementUpdate', lastArrangementUpdate);
                
                // Reset weekly tasks for new arrangement
                weeklyTasks = {};
                initializeWeeklyTasks();
                
                console.log(`Arrangement automatically updated to #${currentArrangement + 1}`);
                
                // Send notification for arrangement change
                if (currentUser && notificationPermission === 'granted') {
                    const newArrangementData = taskArrangements[currentArrangement];
                    const tasksText = Object.entries(newArrangementData).map(([child, task]) => `${child}: ${task}`).join(', ');
                    sendLocalNotification(
                        `×¡×™×“×•×¨ ×—×“×© ×¤×¢×™×œ! #${currentArrangement + 1} ğŸ”„`,
                        `${tasksText}`,
                        { tag: 'arrangement-change' }
                    );
                }
            }
        }
        
        function shouldUpdateArrangement(now, lastUpdate) {
            // If no previous update recorded, don't update automatically
            if (!lastUpdate) return false;
            
            // Get last Saturday 23:59
            const lastSaturday = getLastSaturday2359();
            
            // If current time is after last Saturday 23:59 AND last update was before that Saturday
            return now > lastSaturday && lastUpdate < lastSaturday;
        }
        
        function getLastSaturday2359() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Sunday, 6 = Saturday
            
            let saturday = new Date(now);
            
            if (dayOfWeek === 6) { // Today is Saturday
                // If it's before 23:59, use last Saturday
                if (now.getHours() < 23 || (now.getHours() === 23 && now.getMinutes() < 59)) {
                    saturday.setDate(saturday.getDate() - 7);
                }
                // If it's after 23:59, use today
            } else {
                // Go back to last Saturday
                const daysBack = dayOfWeek === 0 ? 1 : dayOfWeek + 1;
                saturday.setDate(saturday.getDate() - daysBack);
            }
            
            saturday.setHours(23, 59, 0, 0);
            return saturday;
        }

        // Data processing function
        function processData(snapshot) {
            const data = snapshot.val();
            if (!data) {
                console.log("No data found in Firebase. Initializing empty state.");
                calendar = [];
                shoppingList = [];
                customTasks = [];
                weeklyTasks = {};
                lastArrangementUpdate = null;
            } else {
                calendar = data.calendar || [];
                shoppingList = data.shopping || [];
                customTasks = data.customTasks || [];
                weeklyTasks = data.weeklyTasks || {};
                currentArrangement = data.arrangement || 0;
                lastArrangementUpdate = data.lastArrangementUpdate || null;
            }

            // Check for automatic arrangement update
            checkAndUpdateArrangement();
            
            initializeWeeklyTasks();

            if (isInitialLoad) {
                renderApp();
                isInitialLoad = false;
            } else {
                renderCurrentView();
            }
        }
        
        // Firebase Functions
        async function saveData(path, data) {
            try {
                if(!database) return;
                await database.ref(`family/${path}`).set(data);
                console.log(`Data saved successfully: ${path}`);
            } catch (error) {
                console.error(`Error saving data: ${path}`, error);
            }
        }

        // Calendar Functions
        async function addCalendarEvent(activity, members, date, time = null, transports = [], recurring = 'none') {
            const baseEvent = {
                id: Date.now(),
                activity: activity,
                members: members,
                date: date,
                time: time,
                recurring: recurring,
                isRecurring: false
            };

            if (transports.length === 0) {
                // No transport - single event
                calendar.push(baseEvent);
                
                if (recurring && recurring !== 'none') {
                    const recurringEvents = generateRecurringEvents(baseEvent, recurring);
                    calendar.push(...recurringEvents);
                }
            } else {
                // Multiple transport events
                transports.forEach((transport, index) => {
                    const newEvent = {
                        ...baseEvent,
                        id: Date.now() + index,
                        activity: `${activity} - ${transport.type}`,
                        transport: transport.type,
                        driver: transport.driver || '×œ× ×”×•×’×“×¨',
                        transportTime: transport.time || null
                    };
                    calendar.push(newEvent);
                    
                    if (recurring && recurring !== 'none') {
                        const recurringEvents = generateRecurringEvents(newEvent, recurring);
                        calendar.push(...recurringEvents);
                    }
                });
            }

            await saveData('calendar', calendar);
            
            // Send notification for new event
            if (currentUser && notificationPermission === 'granted') {
                const membersList = Array.isArray(members) ? members.join(', ') : members;
                sendLocalNotification(
                    '××™×¨×•×¢ ×—×“×© × ×•×¡×£! ğŸ“…',
                    `${activity} - ${membersList}${time ? ` ×‘×©×¢×” ${formatTime(time)}` : ''}`,
                    { tag: 'new-event' }
                );
            }
        }

        async function updateCalendarEvent(eventId, activity, members, date, time = null, transports = [], recurring = 'none') {
            const eventIndex = calendar.findIndex(event => event.id === eventId);
            if (eventIndex === -1) return;

            const oldEvent = calendar[eventIndex];
            
            // Remove old recurring events if they exist
            if (oldEvent.recurring && oldEvent.recurring !== 'none') {
                calendar = calendar.filter(event => event.originalEventId !== eventId);
            }

            calendar[eventIndex] = {
                ...oldEvent,
                activity: activity,
                members: members,
                date: date,
                time: time,
                transport: transports.length > 0 ? transports[0].type : null,
                driver: transports.length > 0 ? (transports[0].driver || '×œ× ×”×•×’×“×¨') : null,
                transportTime: transports.length > 0 ? transports[0].time : null,
                recurring: recurring
            };

            if (recurring && recurring !== 'none') {
                const recurringEvents = generateRecurringEvents(calendar[eventIndex], recurring);
                calendar.push(...recurringEvents);
            }

            await saveData('calendar', calendar);
        }

        async function removeCalendarEvent(id, deleteType = 'single') {
            if (deleteType === 'all') {
                // Delete all recurring events
                calendar = calendar.filter(event => event.id !== id && event.originalEventId !== id);
            } else {
                // Delete only single event
                calendar = calendar.filter(event => event.id !== id);
            }
            await saveData('calendar', calendar);
        }

        // Edit Event Functions
        function openEditModal(eventId) {
            const event = calendar.find(e => e.id === eventId);
            if (!event) return;

            editingEventId = eventId;
            
            document.getElementById('edit-event-activity').value = event.activity;
            document.getElementById('edit-event-date').value = event.date;
            document.getElementById('edit-event-time').value = event.time || '';

            // Clear previous selections
            document.querySelectorAll('#edit-member-options .active, #edit-transport-options .active, #edit-recurring-options .active').forEach(btn => {
                btn.classList.remove('active');
            });

            // Set members
            if (event.members && Array.isArray(event.members)) {
                event.members.forEach(member => {
                    const memberBtn = document.querySelector(`#edit-member-options [data-value="${member}"]`);
                    if (memberBtn) memberBtn.classList.add('active');
                });
            }

            // Set transport
            if (event.transport) {
                const transportBtn = document.querySelector(`#edit-transport-options [data-value="${event.transport}"]`);
                if (transportBtn) {
                    transportBtn.classList.add('active');
                    updateTransportTimes('edit');
                    
                    // Set transport details
                    setTimeout(() => {
                        const driverSelect = document.querySelector(`[data-transport="${event.transport}"][data-field="driver"]`);
                        const timeInput = document.querySelector(`[data-transport="${event.transport}"][data-field="time"]`);
                        if (driverSelect && event.driver) driverSelect.value = event.driver;
                        if (timeInput && event.transportTime) timeInput.value = event.transportTime;
                    }, 100);
                }
            }

            // Set recurring
            const recurringValue = event.recurring || 'none';
            const recurringBtn = document.querySelector(`#edit-recurring-options [data-value="${recurringValue}"]`);
            if (recurringBtn) recurringBtn.classList.add('active');

            document.getElementById('edit-event-modal').classList.add('show');
        }

        function closeEditModal() {
            editingEventId = null;
            document.getElementById('edit-event-modal').classList.remove('show');
            
            document.getElementById('edit-event-activity').value = '';
            document.getElementById('edit-event-date').value = '';
            document.getElementById('edit-event-time').value = '';

            document.querySelectorAll('#edit-member-options .active, #edit-transport-options .active, #edit-recurring-options .active').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById('edit-transport-times').innerHTML = '';
        }

        async function saveEditedEvent() {
            if (!editingEventId) return;

            const activity = document.getElementById('edit-event-activity').value;
            const date = document.getElementById('edit-event-date').value;
            const time = document.getElementById('edit-event-time').value;

            const selectedMembers = Array.from(document.querySelectorAll('#edit-member-options .active')).map(btn => btn.dataset.value);
            const selectedTransports = Array.from(document.querySelectorAll('#edit-transport-options .active')).map(btn => {
                const transportType = btn.dataset.value;
                const driverSelect = document.querySelector(`[data-transport="${transportType}"][data-field="driver"]`);
                const timeInput = document.querySelector(`[data-transport="${transportType}"][data-field="time"]`);
                
                return {
                    type: transportType,
                    driver: driverSelect ? driverSelect.value : null,
                    time: timeInput ? timeInput.value : null
                };
            });
            const selectedRecurring = document.querySelector('#edit-recurring-options .active')?.dataset.value || 'none';

            if (activity && selectedMembers.length > 0 && date) {
                await updateCalendarEvent(editingEventId, activity, selectedMembers, date, time, selectedTransports, selectedRecurring);
                closeEditModal();
            }
        }

        // Delete Event Functions
        function openDeleteModal(eventId, event) {
            deletingEventId = eventId;
            const isRecurring = event.recurring && event.recurring !== 'none';
            
            // Show event details
            const detailsDiv = document.getElementById('event-delete-details');
            if (detailsDiv && event) {
                const membersList = Array.isArray(event.members) ? event.members.join(', ') : event.member || '';
                const eventDate = formatDate(event.date);
                const eventTime = event.time ? ` ×‘×©×¢×” ${formatTime(event.time)}` : '';
                
                detailsDiv.innerHTML = `
                    <div class="font-medium">${event.activity}</div>
                    <div class="text-xs mt-1">${eventDate}${eventTime}</div>
                    <div class="text-xs">××©×ª×ª×¤×™×: ${membersList}</div>
                    ${isRecurring || event.isRecurring ? '<div class="text-xs text-orange-600 font-medium">âŸ² ××™×¨×•×¢ ×—×•×–×¨</div>' : ''}
                `;
            }
            
            if (isRecurring || event.isRecurring) {
                document.getElementById('recurring-delete-options').style.display = 'block';
                document.getElementById('single-delete-options').style.display = 'none';
            } else {
                document.getElementById('recurring-delete-options').style.display = 'none';
                document.getElementById('single-delete-options').style.display = 'block';
            }
            
            document.getElementById('delete-event-modal').classList.add('show');
            
            // Initialize icons
            setTimeout(() => lucide.createIcons(), 100);
        }

        function closeDeleteModal() {
            deletingEventId = null;
            document.getElementById('delete-event-modal').classList.remove('show');
        }

        async function deleteEvent(type) {
            if (!deletingEventId) return;
            
            await removeCalendarEvent(deletingEventId, type);
            closeDeleteModal();
            renderCurrentView();
        }

        // Delete from edit modal
        function deleteFromEdit() {
            if (!editingEventId) return;
            
            const event = calendar.find(e => e.id === editingEventId);
            if (!event) return;
            
            // Close edit modal first
            closeEditModal();
            
            // Open delete modal with the event
            openDeleteModal(editingEventId, event);
        }

        // Weekly tasks functions
        async function toggleWeeklyTask(weekKey, day, task) {
            if (weeklyTasks[weekKey] && weeklyTasks[weekKey][day] && weeklyTasks[weekKey][day][task]) {
                weeklyTasks[weekKey][day][task].completed = !weeklyTasks[weekKey][day][task].completed;
                await saveData('weeklyTasks', weeklyTasks);
                renderCurrentView();
            }
        }


        // Other data functions
        async function addShoppingItem(item, addedBy) {
            const newItem = {
                id: Date.now(),
                item: item,
                addedBy: addedBy || '×œ× ×™×“×•×¢',
                completed: false,
                dateAdded: new Date().toISOString()
            };
            shoppingList.push(newItem);
            await saveData('shopping', shoppingList);
            
            // Send notification for new shopping item
            if (currentUser && notificationPermission === 'granted') {
                sendLocalNotification(
                    '×¤×¨×™×˜ ×—×“×© × ×•×¡×£ ×œ×§× ×™×•×ª! ğŸ›’',
                    `${item} - × ×•×¡×£ ×¢×œ ×™×“×™ ${addedBy}`,
                    { tag: 'new-shopping' }
                );
            }
        }

        async function toggleShoppingItem(id) {
            const item = shoppingList.find(item => item.id === id);
            if (item) {
                item.completed = !item.completed;
                await saveData('shopping', shoppingList);
            }
        }

        async function removeShoppingItem(id) {
            shoppingList = shoppingList.filter(item => item.id !== id);
            await saveData('shopping', shoppingList);
        }

        async function addCustomTask(title, assignedTo, targetDate) {
            const newTask = {
                id: Date.now(),
                title: title,
                assignedTo: assignedTo,
                completed: false,
                dateCreated: new Date().toISOString(),
                targetDate: targetDate || null
            };
            customTasks.push(newTask);
            await saveData('customTasks', customTasks);
            
            // Send notification for new custom task
            if (currentUser && notificationPermission === 'granted') {
                sendLocalNotification(
                    '××©×™××” ×—×“×©×” × ×•×¦×¨×”! ğŸ“‹',
                    `${title} - ${assignedTo}${targetDate ? ` ×¢×“ ${formatDate(targetDate)}` : ''}`,
                    { tag: 'new-task' }
                );
            }
        }

        async function toggleCustomTask(id) {
            const task = customTasks.find(task => task.id === id);
            if (task) {
                task.completed = !task.completed;
                await saveData('customTasks', customTasks);
            }
        }

        async function removeCustomTask(id) {
            customTasks = customTasks.filter(task => task.id !== id);
            await saveData('customTasks', customTasks);
        }

        // UI Functions
        function setCurrentView(view) {
            currentView = view;
            renderCurrentView();
            renderNavigation();
        }

        function renderNavigation() {
            const navButtons = document.getElementById('nav-buttons');
            const mobileNavButtons = document.getElementById('mobile-nav-buttons');
            
            const buttonHTML = `
                <button onclick="setCurrentView('home')" class="px-3 sm:px-4 py-2 rounded-lg flex items-center space-x-1 text-sm touch-manipulation ${currentView === 'home' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="home" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">×‘×™×ª</span>
                </button>
                <button onclick="setCurrentView('calendar')" class="px-3 sm:px-4 py-2 rounded-lg flex items-center space-x-1 text-sm touch-manipulation ${currentView === 'calendar' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">×œ×•×—</span>
                </button>
                <button onclick="setCurrentView('shopping')" class="px-3 sm:px-4 py-2 rounded-lg flex items-center space-x-1 text-sm touch-manipulation ${currentView === 'shopping' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">×§× ×™×•×ª</span>
                </button>
                <button onclick="setCurrentView('custom-tasks')" class="px-3 sm:px-4 py-2 rounded-lg flex items-center space-x-1 text-sm touch-manipulation ${currentView === 'custom-tasks' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">××©×™××•×ª</span>
                </button>
            `;
            
            const mobileButtonHTML = `
                <div class="flex justify-center space-x-1 px-2">
                    <button onclick="setCurrentView('home')" class="flex-1 px-3 py-2 rounded-lg flex flex-col items-center text-xs touch-manipulation ${currentView === 'home' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                        <i data-lucide="home" class="w-4 h-4 mb-1"></i>
                        <span>×‘×™×ª</span>
                    </button>
                    <button onclick="setCurrentView('calendar')" class="flex-1 px-3 py-2 rounded-lg flex flex-col items-center text-xs touch-manipulation ${currentView === 'calendar' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                        <i data-lucide="calendar" class="w-4 h-4 mb-1"></i>
                        <span>×œ×•×—</span>
                    </button>
                    <button onclick="setCurrentView('shopping')" class="flex-1 px-3 py-2 rounded-lg flex flex-col items-center text-xs touch-manipulation ${currentView === 'shopping' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                        <i data-lucide="shopping-cart" class="w-4 h-4 mb-1"></i>
                        <span>×§× ×™×•×ª</span>
                    </button>
                    <button onclick="setCurrentView('custom-tasks')" class="flex-1 px-3 py-2 rounded-lg flex flex-col items-center text-xs touch-manipulation ${currentView === 'custom-tasks' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                        <i data-lucide="plus" class="w-4 h-4 mb-1"></i>
                        <span>××©×™××•×ª</span>
                    </button>
                </div>
            `;
            
            navButtons.innerHTML = buttonHTML;
            mobileNavButtons.innerHTML = mobileButtonHTML;
            lucide.createIcons();
        }

        function renderHomeView() {
            const pendingShoppingItems = shoppingList.filter(item => !item.completed).length;
            const currentArrangementData = taskArrangements[currentArrangement];
            
            // Get today's events with correct date handling
            const today = new Date();
            const todayStr = getDateString(today);
            const todayEvents = getFilteredCalendarEvents().filter(event => event.date === todayStr);
            
            const getWeekTasksHTML = (weekOffset) => {
                const weekKey = getWeekKey(weekOffset);
                const weekStart = getWeekStartDate(weekOffset);
                const weekTasks = weeklyTasks[weekKey] || {};
                
                return `
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-7 gap-2 sm:gap-3">
                        ${daysOfWeekHebrew.map(day => {
                            const dayTasks = weekTasks[day] || {};
                            const filteredTasks = getFilteredTasks(dayTasks, dayTasks);
                            
                            // Filter out completed tasks, dog walking, and weekly chores for home view
                            const weeklyChores = ['×¤×—', '××—×–×•×¨', '××“×™×—'];
                            const openTasks = {};
                            Object.entries(filteredTasks).forEach(([taskName, taskInfo]) => {
                                if (!taskInfo.completed && taskName !== '×˜×™×•×œ ×¢× ×‘××‘×”' && !weeklyChores.includes(taskName)) {
                                    openTasks[taskName] = taskInfo;
                                }
                            });
                            
                            const dayDate = new Date(weekStart);
                            const dayIndex = daysOfWeekHebrew.indexOf(day);
                            dayDate.setDate(weekStart.getDate() + dayIndex);
                            const isToday = isSameDate(dayDate, today);
                            const dateStr = getDateString(dayDate);
                            const dayEvents = getFilteredCalendarEvents().filter(event => event.date === dateStr);
                            const dayCustomTasks = getCustomTasksForDate(dateStr).filter(task => !task.completed);
                            
                            const totalItems = Object.keys(openTasks).length + dayEvents.length + dayCustomTasks.length;
                            const hasItems = totalItems > 0;
                            
                            return `
                                <div class="bg-white p-4 rounded-lg shadow ${isToday ? 'border-2 border-blue-400' : 'border border-gray-200'} ${hasItems ? 'cursor-pointer hover:shadow-md' : ''}" 
                                     ${hasItems ? `onclick="openDayEventsModal('${dateStr}', '${day}')"` : ''}>
                                    <div class="text-center mb-3">
                                        <h4 class="font-bold text-gray-800">${day}</h4>
                                        <p class="text-xs text-gray-500">${formatDate(dayDate)}</p>
                                        ${isToday ? '<p class="text-xs text-blue-600 font-bold">×”×™×•×</p>' : ''}
                                        ${totalItems > 0 ? `<p class="text-xs text-green-600 font-bold">${totalItems} ×¤×¨×™×˜×™×</p>` : ''}
                                    </div>
                                    
                                    <div class="space-y-2">
                                        ${Object.entries(openTasks).slice(0, 2).map(([task, taskInfo]) => `
                                            <div class="p-2 rounded text-xs weekly-task-item">
                                                <div class="flex items-center justify-between">
                                                    <button onclick="event.stopPropagation(); toggleWeeklyTask('${weekKey}', '${day}', '${task.replace(/'/g, "\\'")}')">
                                                        <i data-lucide="circle" class="w-3 h-3 text-gray-400 hover:text-green-500"></i>
                                                    </button>
                                                    <div class="flex-1 mr-2">
                                                        <div class="text-gray-800">${task}</div>
                                                        <div class="text-xs ${memberColors[taskInfo.assignedTo.split(' ')[0]] || 'text-blue-600'} rounded px-1">${taskInfo.assignedTo}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                        
                                        ${dayEvents.slice(0, hasItems ? 1 : 2).map(event => `
                                            <div class="p-2 rounded text-xs calendar-event-item">
                                                <div class="font-medium text-indigo-800 truncate">${event.activity}</div>
                                                ${event.time ? `<div class="text-xs text-indigo-600">â° ${formatTime(event.time)}</div>` : ''}
                                            </div>
                                        `).join('')}
                                        
                                        ${dayCustomTasks.slice(0, hasItems ? 1 : 2).map(task => `
                                            <div class="p-2 rounded text-xs custom-task-item">
                                                <div class="flex items-center justify-between">
                                                    <button onclick="event.stopPropagation(); toggleCustomTask(${task.id})">
                                                        <i data-lucide="circle" class="w-3 h-3 text-orange-400 hover:text-orange-500"></i>
                                                    </button>
                                                    <div class="flex-1 mr-2">
                                                        <div class="text-orange-800 font-medium truncate">ğŸ“‹ ${task.title}</div>
                                                        <div class="text-xs ${memberColors[task.assignedTo] || 'text-orange-600'} rounded px-1">${task.assignedTo}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                        
                                        ${totalItems > 3 ? `<div class="text-xs text-gray-500 text-center">+${totalItems - 3} ×¢×•×“...</div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            };

            return `
                <div class="space-y-6">
                    <!-- Member Filter -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-bold text-gray-800 mb-3">×¤×™×œ×˜×¨ ×œ×¤×™ ×‘×Ÿ ××©×¤×—×”</h3>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="setMemberFilter(null)" class="filter-btn ${!selectedMemberFilter ? 'active' : ''}" data-member="">
                                ×”×›×œ
                            </button>
                            ${familyMembers.map(member => `
                                <button onclick="setMemberFilter('${member}')" class="filter-btn ${selectedMemberFilter === member ? 'active' : ''}" data-member="${member}">
                                    ${member}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Today's Events -->
                    ${todayEvents.length > 0 ? `
                        <div class="bg-indigo-50 border border-indigo-200 p-4 rounded-lg">
                            <h3 class="text-lg font-bold text-indigo-800 mb-3">××™×¨×•×¢×™ ×”×™×•× (${formatDate(today)})</h3>
                            <div class="space-y-2">
                                ${todayEvents.map(event => `
                                    <div class="p-3 bg-white rounded border border-indigo-200">
                                        <div class="font-medium text-indigo-800">${event.activity}</div>
                                        ${event.time ? `<div class="text-sm text-indigo-600">â° ${formatTime(event.time)}</div>` : ''}
                                        ${event.transport ? `<div class="text-sm text-indigo-600">ğŸš— ${event.transport} ${event.transportTime ? `- ${formatTime(event.transportTime)}` : ''}</div>` : ''}
                                        <div class="text-sm text-gray-600">ğŸ‘¥ ${Array.isArray(event.members) ? event.members.join(', ') : event.member || ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Today's Custom Tasks -->
                    ${getCustomTasksForDate(todayStr).filter(task => !task.completed).length > 0 ? `
                        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                            <h3 class="text-lg font-bold text-yellow-800 mb-3">××©×™××•×ª ×œ×™×•× (${formatDate(today)})</h3>
                            <div class="space-y-2">
                                ${getCustomTasksForDate(todayStr).filter(task => !task.completed).map(task => `
                                    <div class="p-3 bg-white rounded border border-yellow-200">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <button onclick="toggleCustomTask(${task.id})">
                                                    <i data-lucide="circle" class="w-5 h-5 text-yellow-500"></i>
                                                </button>
                                                <div>
                                                    <div class="font-medium text-yellow-800">ğŸ“‹ ${task.title}</div>
                                                    <div class="text-sm text-gray-600">××—×¨××™: ${task.assignedTo}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Weekly Task Arrangement -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-bold text-gray-800 mb-3">× ×™×”×•×œ ××©×™××•×ª ×©×‘×•×¢×™×•×ª</h3>
                        
                        <!-- Current Arrangement -->
                        <div class="bg-blue-50 p-3 rounded-lg mb-3">
                            <div>
                                <h4 class="text-base font-semibold text-blue-800">×¡×™×“×•×¨ × ×•×›×—×™ #${currentArrangement + 1}</h4>
                                <div class="text-sm text-blue-700 mt-1">
                                    ${Object.entries(currentArrangementData).map(([child, task]) => 
                                        `<span class="inline-block ml-2 px-2 py-1 rounded text-xs ${memberColors[child]}">${child}: ${task}</span>`
                                    ).join('')}
                                </div>
                                <div class="text-xs text-blue-600 mt-2">
                                    ğŸ”„ ××ª×¢×“×›×Ÿ ××•×˜×•××˜×™×ª ×›×œ ××•×¦××™ ×©×‘×ª ×‘-23:59
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dog Walking Schedule -->
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h4 class="text-base font-semibold text-gray-700 mb-2">×˜×™×•×œ×™× ×¢× ×‘××‘×”</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-1 text-xs">
                                ${Object.entries(dogWalkingSchedule).map(([day, person]) => `
                                    <div class="p-1 rounded bg-white border border-gray-200">
                                        <span class="font-medium">${day}</span>: 
                                        <span class="${memberColors[person.split(' ')[0]] || 'text-gray-700'}">${person}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    ${pendingShoppingItems > 0 ? `
                        <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg cursor-pointer" onclick="setCurrentView('shopping')">
                            <div class="flex items-center">
                                <i data-lucide="shopping-cart" class="w-5 h-5 text-orange-600 ml-2"></i>
                                <span class="font-medium text-orange-800">
                                    ×™×© ${pendingShoppingItems} ×¤×¨×™×˜×™× ×‘×¨×©×™××ª ×”×§× ×™×•×ª
                                </span>
                            </div>
                        </div>
                    ` : ''}

                    <div class="week-header">
                        <h3 class="text-xl font-bold">×”×©×‘×•×¢ ×”× ×•×›×—×™</h3>
                        <p class="text-sm opacity-90">${formatDate(getWeekStartDate(0))} - ${formatDate(new Date(getWeekStartDate(0).getTime() + 6 * 24 * 60 * 60 * 1000))}</p>
                        ${selectedMemberFilter ? `<p class="text-sm opacity-90">××¦×™×’ ××©×™××•×ª ×©×œ: ${selectedMemberFilter}</p>` : ''}
                        <p class="text-sm opacity-90">ğŸ’¡ ×œ×—×¥ ×¢×œ ×™×•× ×œ×¨××•×ª ××ª ×›×œ ×”××™×¨×•×¢×™× (××¦×™×’ ×¨×§ ××©×™××•×ª ×¤×ª×•×—×•×ª)</p>
                        <div class="text-xs mt-2 space-x-4">
                            <span class="inline-flex items-center">
                                <div class="w-3 h-3 calendar-event-item rounded mr-1"></div>
                                ××™×¨×•×¢×™ ×œ×•×— ×©× ×”
                            </span>
                            <span class="inline-flex items-center">
                                <div class="w-3 h-3 custom-task-item rounded mr-1"></div>
                                ××©×™××•×ª ××•×ª×××•×ª ××™×©×™×ª
                            </span>
                        </div>
                    </div>
                    ${getWeekTasksHTML(0)}

                    <div class="week-header">
                        <h3 class="text-xl font-bold">×”×©×‘×•×¢ ×”×‘×</h3>
                        <p class="text-sm opacity-90">${formatDate(getWeekStartDate(1))} - ${formatDate(new Date(getWeekStartDate(1).getTime() + 6 * 24 * 60 * 60 * 1000))}</p>
                        ${selectedMemberFilter ? `<p class="text-sm opacity-90">××¦×™×’ ××©×™××•×ª ×©×œ: ${selectedMemberFilter}</p>` : ''}
                        <p class="text-sm opacity-90">ğŸ’¡ ×œ×—×¥ ×¢×œ ×™×•× ×œ×¨××•×ª ××ª ×›×œ ×”××™×¨×•×¢×™× (××¦×™×’ ×¨×§ ××©×™××•×ª ×¤×ª×•×—×•×ª)</p>
                    </div>
                    ${getWeekTasksHTML(1)}
                </div>
            `;
        }

        function renderCalendarView() {
            const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
            
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
            const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const monthEvents = getFilteredCalendarEvents().filter(event => {
                const eventDate = new Date(event.date + 'T00:00:00');
                return eventDate.getMonth() === currentCalendarMonth && eventDate.getFullYear() === currentCalendarYear;
            });

            const getEventsForDay = (day) => {
                const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                return monthEvents.filter(event => event.date === dateStr);
            };

            const getCustomTasksForDay = (day) => {
                const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                return getCustomTasksForDate(dateStr);
            };

            const generateCalendar = () => {
                let calendar = [];
                let week = [];
                
                for (let i = 0; i < startingDayOfWeek; i++) {
                    week.push('<div class="h-32 bg-gray-50"></div>');
                }
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEvents = getEventsForDay(day);
                    const dayCustomTasks = getCustomTasksForDay(day);
                    const today = new Date();
                    const isToday = today.getDate() === day && today.getMonth() === currentCalendarMonth && today.getFullYear() === currentCalendarYear;
                    const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const totalItems = dayEvents.length + dayCustomTasks.length;
                    const dayName = getDayOfWeekFromDate(dateStr);
                    
                    week.push(`
                        <div class="h-20 sm:h-32 border border-gray-200 p-1 ${isToday ? 'bg-blue-50 border-blue-300' : 'bg-white'} ${totalItems > 0 ? 'cursor-pointer hover:shadow-md' : ''} calendar-day" 
                             ${totalItems > 0 ? `onclick="openDayEventsModal('${dateStr}', '${dayName}')"` : ''}>
                            <div class="text-xs sm:text-sm font-medium ${isToday ? 'text-blue-700' : 'text-gray-700'} mb-1">${day}</div>
                            ${totalItems > 0 ? `<div class="text-xs text-green-600 font-bold mb-1">${totalItems} ×¤×¨×™×˜×™×</div>` : ''}
                            <div class="space-y-1 overflow-hidden">
                                ${dayEvents.slice(0, 1).map(event => {
                                    const firstMember = Array.isArray(event.members) && event.members.length > 0 ? event.members[0] : event.member || '';
                                    const memberColor = memberColors[firstMember] || 'bg-gray-100 border-gray-300 text-gray-800';
                                    const eventObj = JSON.stringify(event).replace(/"/g, '&quot;');
                                    return `
                                        <div class="text-xs p-1 rounded ${memberColor} truncate calendar-event" onclick="event.stopPropagation(); openEditModal(${event.id})" title="${event.activity}">
                                            <div class="event-actions">
                                                <button class="action-btn edit-btn" onclick="event.stopPropagation(); openEditModal(${event.id})" title="×¢×¨×•×š">
                                                    âœï¸
                                                </button>
                                                <button class="action-btn delete-btn" onclick="event.stopPropagation(); openDeleteModal(${event.id}, ${eventObj})" title="××—×§">
                                                    ğŸ—‘ï¸
                                                </button>
                                            </div>
                                            ${event.activity.substring(0, 12)}${event.activity.length > 12 ? '...' : ''}
                                            ${event.time ? `<br>â° ${formatTime(event.time)}` : ''}
                                        </div>
                                    `;
                                }).join('')}
                                ${dayCustomTasks.slice(0, totalItems > 2 ? 1 : 2).map(task => `
                                    <div class="text-xs p-1 rounded custom-task-item truncate" title="${task.title}">
                                        ğŸ“‹ ${task.title.substring(0, 10)}${task.title.length > 10 ? '...' : ''}
                                    </div>
                                `).join('')}
                                ${totalItems > 3 ? `<div class="text-xs text-gray-500 text-center">+${totalItems - 3}</div>` : ''}
                            </div>
                        </div>
                    `);
                    
                    if (week.length === 7) {
                        calendar.push(`<div class="grid grid-cols-7 gap-1">${week.join('')}</div>`);
                        week = [];
                    }
                }
                
                while (week.length < 7 && week.length > 0) {
                    week.push('<div class="h-32 bg-gray-50"></div>');
                }
                if (week.length === 7) {
                    calendar.push(`<div class="grid grid-cols-7 gap-1">${week.join('')}</div>`);
                }
                
                return calendar.join('');
            };

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">×œ×•×— ××©×¤×—×ª×™</h2>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">×”×•×¡×¤×ª ××™×¨×•×¢</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                            <input type="text" placeholder="×¤×¢×™×œ×•×ª" class="p-3 border rounded-lg text-base" id="new-event-activity">
                            <input type="date" class="p-3 border rounded-lg text-base" id="new-event-date">
                            <input type="time" class="p-3 border rounded-lg text-base" id="new-event-time" title="×©×¢×ª ×”××™×¨×•×¢">
                        </div>

                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">××©×ª×ª×¤×™× (×‘×—×™×¨×” ××¨×•×‘×”)</h4>
                            <div id="member-options" class="flex items-center gap-2 flex-wrap">
                                ${familyMembers.map(member => `
                                    <button type="button" class="transport-option-btn touch-manipulation" data-value="${member}" onclick="toggleMember(this)">${member}</button>
                                `).join('')}
                            </div>
                        </div>

                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">×¡×•×’ ×”×¡×¢×” (×‘×—×™×¨×” ××¨×•×‘×”)</h4>
                            <div id="transport-options" class="flex items-center gap-2 sm:gap-3 mb-3 flex-wrap">
                                <button type="button" class="transport-option-btn touch-manipulation" data-value="×”×œ×•×š" onclick="toggleTransport(this)">×”×œ×•×š</button>
                                <button type="button" class="transport-option-btn touch-manipulation" data-value="×—×–×•×¨" onclick="toggleTransport(this)">×—×–×•×¨</button>
                                <button type="button" class="transport-option-btn touch-manipulation" data-value="×œ×¨×›×‘×ª" onclick="toggleTransport(this)">×œ×¨×›×‘×ª</button>
                            </div>
                            
                            <div id="transport-times" class="space-y-3"></div>
                        </div>

                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">××™×¨×•×¢ ×—×•×–×¨</h4>
                            <div id="recurring-options" class="flex items-center gap-2 flex-wrap">
                                <button type="button" class="recurring-option-btn active touch-manipulation" data-value="none" onclick="toggleRecurring(this)">×œ×œ× ×—×–×¨×”</button>
                                <button type="button" class="recurring-option-btn touch-manipulation" data-value="daily" onclick="toggleRecurring(this)">×™×•××™</button>
                                <button type="button" class="recurring-option-btn touch-manipulation" data-value="weekly" onclick="toggleRecurring(this)">×©×‘×•×¢×™</button>
                                <button type="button" class="recurring-option-btn touch-manipulation" data-value="monthly" onclick="toggleRecurring(this)">×—×•×“×©×™</button>
                            </div>
                        </div>
                        
                        <button onclick="addNewCalendarEvent()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            ×”×•×¡×£ ××™×¨×•×¢
                        </button>
                    </div>

                    <!-- Calendar Display -->
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="changeCalendarMonth(-1)" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </button>
                            <h3 class="text-xl font-bold text-gray-800">${monthNames[currentCalendarMonth]} ${currentCalendarYear}</h3>
                            <button onclick="changeCalendarMonth(1)" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-7 gap-1 mb-2">
                            ${['×', '×‘', '×’', '×“', '×”', '×•', '×©'].map(day => 
                                `<div class="text-center font-medium text-gray-600 py-1 sm:py-2 text-sm">${day}</div>`
                            ).join('')}
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-4">ğŸ’¡ ×œ×—×¥ ×¢×œ ×™×•× ×¢× ××™×¨×•×¢×™× ×œ×¨××•×ª ××ª ×›×œ ×”×¤×¨×˜×™×</p>
                        
                        ${generateCalendar()}
                    </div>
                </div>
            `;
        }

        function changeCalendarMonth(direction) {
            currentCalendarMonth += direction;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            renderCurrentView();
        }

        function renderShoppingView() {
           return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">×¨×©×™××ª ×§× ×™×•×ª</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <input type="text" placeholder="××” ×œ×§× ×•×ª?" class="p-3 border rounded-lg text-base" id="new-item" onkeypress="if(event.key === 'Enter') addNewShoppingItem()">
                            <select class="p-3 border rounded-lg text-base" id="new-item-by">
                                <option value="">××™ ××‘×§×©?</option>
                                ${familyMembers.map(member => `<option value="${member}">${member}</option>`).join('')}
                            </select>
                        </div>
                        <button onclick="addNewShoppingItem()" class="w-full sm:w-auto px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 touch-manipulation">
                            ×”×•×¡×£ ×œ×¨×©×™××”
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-lg font-bold text-red-600 mb-4">
                                ×œ×§× ×•×ª (${shoppingList.filter(item => !item.completed).length})
                            </h3>
                            <div class="space-y-2">
                                ${shoppingList.filter(item => !item.completed).map(item => `
                                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                        <div class="flex items-center space-x-2">
                                            <button onclick="toggleShoppingItem(${item.id})">
                                                <i data-lucide="circle" class="w-5 h-5 text-red-500"></i>
                                            </button>
                                            <div>
                                                <div class="font-medium">${item.item}</div>
                                                <div class="text-sm text-gray-600">×”×•×¡×™×£/×”: ${item.addedBy}</div>
                                            </div>
                                        </div>
                                        <button onclick="removeShoppingItem(${item.id})">
                                            <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-lg font-bold text-green-600 mb-4">
                                × ×§× ×• (${shoppingList.filter(item => item.completed).length})
                            </h3>
                            <div class="space-y-2">
                                ${shoppingList.filter(item => item.completed).map(item => `
                                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                        <div class="flex items-center space-x-2">
                                             <button onclick="toggleShoppingItem(${item.id})">
                                                <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                                             </button>
                                            <div>
                                                <div class="font-medium line-through text-gray-500">${item.item}</div>
                                                <div class="text-sm text-gray-500">×”×•×¡×™×£/×”: ${item.addedBy}</div>
                                            </div>
                                        </div>
                                        <button onclick="removeShoppingItem(${item.id})">
                                            <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCustomTasksView() {
            const currentArrangementData = taskArrangements[currentArrangement];
            
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">× ×™×”×•×œ ××©×™××•×ª</h2>
                    

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">×”×•×¡×¤×ª ××©×™××” ×—×“ ×¤×¢××™×ª</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                            <input type="text" placeholder="×›×•×ª×¨×ª ×”××©×™××”" class="p-3 border rounded-lg text-base" id="new-task-title">
                            <select class="p-3 border rounded-lg text-base" id="new-task-assignee">
                                <option value="">×œ××™ ×œ×”×§×¦×•×ª?</option>
                                ${familyMembers.map(member => `<option value="${member}">${member}</option>`).join('')}
                            </select>
                            <input type="date" class="p-3 border rounded-lg text-base" id="new-task-target-full" title="×ª××¨×™×š ×™×¢×“">
                        </div>
                        <button onclick="addNewCustomTask()" class="w-full sm:w-auto px-6 py-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 touch-manipulation">
                            ×”×•×¡×£ ××©×™××”
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            ××©×™××•×ª ×¤×¢×™×œ×•×ª (${customTasks.filter(task => !task.completed).length})
                        </h3>
                        <div class="space-y-3">
                            ${customTasks.filter(task => !task.completed).map(task => `
                                <div class="p-4 rounded-lg border bg-gray-50 border-gray-200">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <button onclick="toggleCustomTask(${task.id})">
                                                <i data-lucide="circle" class="w-6 h-6 text-gray-400 hover:text-green-500"></i>
                                            </button>
                                            <div>
                                                <div class="font-medium text-lg">${task.title}</div>
                                                <div class="text-sm text-gray-600">
                                                    ××—×¨××™: <span class="${memberColors[task.assignedTo] || 'text-gray-700'}">${task.assignedTo}</span>
                                                    ${task.targetDate ? `â€¢ ×™×¢×“: ${new Date(task.targetDate + 'T00:00:00').toLocaleDateString('he-IL')}` : ''}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="removeCustomTask(${task.id})">
                                                <i data-lucide="trash-2" class="w-5 h-5 text-red-500"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-bold text-green-600 mb-4">
                            ××©×™××•×ª ×©×‘×•×¦×¢×• (${customTasks.filter(task => task.completed).length})
                        </h3>
                        <div class="space-y-2">
                            ${customTasks.filter(task => task.completed).map(task => `
                                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                    <div class="flex items-center space-x-2">
                                         <button onclick="toggleCustomTask(${task.id})">
                                            <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                                         </button>
                                        <div>
                                            <div class="font-medium line-through text-gray-500">${task.title}</div>
                                            <div class="text-sm text-gray-500">${task.assignedTo}</div>
                                        </div>
                                    </div>
                                    <button onclick="removeCustomTask(${task.id})">
                                        <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderCurrentView() {
            let content = '';
            switch (currentView) {
                case 'home': content = renderHomeView(); break;
                case 'calendar': content = renderCalendarView(); break;
                case 'shopping': content = renderShoppingView(); break;
                case 'custom-tasks': content = renderCustomTasksView(); break;
                default: content = renderHomeView();
            }
            document.getElementById('main-content').innerHTML = content;
            lucide.createIcons();
        }

        function renderApp() {
            renderNavigation();
            renderCurrentView();
        }

        function initializeApp() {
            if (!database) {
                console.error('Database not initialized. Halting execution.');
                return;
            }

            // Initialize notifications
            initializeNotifications();

            // Listen for real-time updates from Firebase
            try {
                database.ref('family').on('value', (snapshot) => {
                    console.log('Real-time update from database received.');
                    processData(snapshot);
                }, (error) => {
                    console.error('Error listening for real-time updates:', error);
                });
            } catch (error) {
                console.error('Error setting up real-time listener:', error);
            }
        }
        
        // Helper UI Functions
        function addNewShoppingItem() {
            const itemInput = document.getElementById('new-item');
            const bySelect = document.getElementById('new-item-by');
            if (itemInput.value.trim() && bySelect.value) {
                addShoppingItem(itemInput.value.trim(), bySelect.value);
                itemInput.value = '';
                bySelect.value = '';
            }
        }
        
        function addNewCalendarEvent() {
            const activity = document.getElementById('new-event-activity');
            const date = document.getElementById('new-event-date');
            const time = document.getElementById('new-event-time');
            
            const selectedMembers = Array.from(document.querySelectorAll('#member-options .active')).map(btn => btn.dataset.value);
            const selectedTransports = Array.from(document.querySelectorAll('#transport-options .active')).map(btn => {
                const transportType = btn.dataset.value;
                const driverSelect = document.querySelector(`[data-transport="${transportType}"][data-field="driver"]`);
                const timeInput = document.querySelector(`[data-transport="${transportType}"][data-field="time"]`);
                
                return {
                    type: transportType,
                    driver: driverSelect ? driverSelect.value : null,
                    time: timeInput ? timeInput.value : null
                };
            });
            const selectedRecurring = document.querySelector('#recurring-options .active')?.dataset.value || 'none';

            if (activity.value && selectedMembers.length > 0 && date.value) {
                addCalendarEvent(activity.value, selectedMembers, date.value, time.value, selectedTransports, selectedRecurring);
                
                // Reset form
                activity.value = '';
                date.value = '';
                time.value = '';
                
                // Reset all buttons
                document.querySelectorAll('#member-options .active, #transport-options .active').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Reset recurring to "none"
                document.querySelectorAll('#recurring-options .active').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector('#recurring-options [data-value="none"]').classList.add('active');
                
                // Clear transport times
                document.getElementById('transport-times').innerHTML = '';
            }
        }

        function addNewCustomTask() {
            const title = document.getElementById('new-task-title');
            const assignee = document.getElementById('new-task-assignee');
            const target = document.getElementById('new-task-target-full');
            
            if (title.value && assignee.value) {
                addCustomTask(title.value, assignee.value, target.value);
                title.value = '';
                assignee.value = '';
                target.value = '';
            }
        }
        
        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('=== APP INITIALIZATION START ===');
                console.log('DOM loaded, initializing application...');
                
                // Basic checks
                console.log('Firebase available:', typeof firebase !== 'undefined');
                console.log('Auth available:', typeof auth !== 'undefined' && !!auth);
                console.log('Database available:', typeof database !== 'undefined' && !!database);
                
                if (!auth || !database) {
                    console.error('Firebase not initialized properly. Halting execution.');
                    showAuthError('×©×’×™××” ×‘×”×¤×¢×œ×ª ×”××¢×¨×›×ª. ×× × ×¨×¢× ×Ÿ ××ª ×”×“×£.');
                    return;
                }

                // Check for iOS and show appropriate messaging
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
                console.log('Detected iOS Safari:', isIOS && isSafari);
                
                if (isIOS && isSafari) {
                    const iosHint = document.getElementById('ios-hint');
                    if (iosHint) {
                        iosHint.style.display = 'block';
                    }
                }

                // Set up Google Sign-in button
                const signInBtn = document.getElementById('google-signin-btn');
                if (signInBtn) {
                    signInBtn.addEventListener('click', signInWithGoogle);
                    console.log('Sign-in button event listener attached');
                } else {
                    console.error('Sign-in button not found');
                }

                // Set up authentication state listener
                setupAuthStateListener();
                
                console.log('=== APP INITIALIZATION COMPLETE ===');
                
            } catch (error) {
                console.error('Critical error during initialization:', error);
                showAuthError('×©×’×™××” ×§×¨×™×˜×™×ª ×‘×”×¤×¢×œ×ª ×”××¤×œ×™×§×¦×™×”: ' + error.message);
            }
        });
    </script>
</body>
</html>3 h-3 weekly-task-item rounded mr-1"></div>
                                ××©×™××•×ª ×©×‘×•×¢×™×•×ª
                            </span>
                            <span class="inline-flex items-center">
                                <div class="w-